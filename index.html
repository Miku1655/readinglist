<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reading List</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #111; color: #eee; padding: 20px; margin: 0; }
    h1 { font-size: 1.6em; margin-bottom: 12px; }
    
    /* Tabs */
    .tabs { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 12px; }
    .tab { padding: 8px 16px; background: #1a1a1a; border: 1px solid #333; color: #ccc; cursor: pointer; border-radius: 4px; }
    .tab.active { background: #333; color: #fff; border-color: #555; font-weight: bold; }
    .tab:hover { background: #2a2a2a; }
    
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Forms & Inputs */
    input, select, textarea { margin: 8px 0; padding: 8px; background: #222; color: #eee; border: 1px solid #444; border-radius: 4px; width: 100%; box-sizing: border-box; }
    input[type="checkbox"] { width: auto; margin-right: 8px; }
    label { display: block; margin-bottom: 8px; color: #ccc; }
    
    button { padding: 8px 14px; background: #333; color: #eee; border: 1px solid #555; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
    button:hover { background: #444; }
    button.primary { background: #2c5282; border-color: #4299e1; }
    button.primary:hover { background: #2b6cb0; }
    button.danger { background: #742a2a; border-color: #e53e3e; }
    button.danger:hover { background: #9b2c2c; }
    
    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; min-width: 600px; }
    th, td { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
    th { background: #1a1a1a; cursor: pointer; user-select: none; white-space: nowrap; }
    th:hover { background: #252525; }
    tr:hover { background: #1f1f1f; }
    .sort { margin-left: 4px; opacity: 0.6; font-size: 0.8em; }
    
    /* Tags */
    .tag { display: inline-block; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 0.85em; background: #333; }

    /* Profile Grid */
    .profile-header { display: flex; gap: 20px; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; }
    .profile-pic-container { position: relative; width: 100px; height: 100px; flex-shrink: 0; }
    .profile-pic { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid #444; background: #222; cursor: pointer; }
    
    .stats-card { background: #1a1a1a; border: 1px solid #333; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px; margin-bottom: 10px; }
    .stats-value { font-size: 1.5em; font-weight: bold; color: #fff; }
    .stats-label { color: #888; font-size: 0.9em; }

    .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 10px; }
    .book-card { background: #1e1e1e; border: 1px solid #333; padding: 8px; border-radius: 6px; cursor: pointer; transition: transform 0.2s; height: 100%; display: flex; flex-direction: column; }
    .book-card:hover { transform: translateY(-2px); border-color: #555; }
    .book-title { font-weight: bold; font-size: 0.9em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 4px; }
    .book-author { font-size: 0.8em; color: #999; margin-top: auto; }

    .profile-section-title { font-size: 0.95em; color: #bbb; text-transform: uppercase; letter-spacing: 1px; margin: 24px 0 12px 0; border-bottom: 1px solid #333; padding-bottom: 6px; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
    .modal-content { background: #222; padding: 24px; border: 1px solid #444; border-radius: 8px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .modal-header { font-size: 1.2em; font-weight: bold; margin-bottom: 16px; border-bottom: 1px solid #333; padding-bottom: 8px; }
    .modal-footer { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 16px; border-top: 1px solid #333; }

    /* Popups */
    .note-popup { display: none; position: absolute; background: #2d2d2d; border: 1px solid #555; padding: 10px; border-radius: 4px; max-width: 300px; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.4); font-size: 0.9em; pointer-events: none; }
    
    @media (max-width: 600px) {
        .tabs { justify-content: center; }
        .tab { flex: 1; text-align: center; }
        .profile-header { flex-direction: column; align-items: center; text-align: center; }
        input[style*="width:300px"] { width: 100% !important; }
    }
</style>
</head>
<body>

<h1>Reading List</h1>

<!-- Auth Status Bar -->
<div style="background: #1a1a1a; padding: 10px; border-radius: 6px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
    <span id="syncStatus">Loading local data...</span>
    <div>
        <button id="signInBtn" class="primary" style="display:none;">Sign in with Google</button>
        <button id="signOutBtn" style="display:none;">Sign Out</button>
    </div>
</div>

<div class="tabs">
    <button class="tab active" data-tab="list">List</button>
    <button class="tab" data-tab="profile">Profile</button>
    <button class="tab" data-tab="stats">Stats</button>
    <button class="tab" data-tab="options">Options</button>
</div>

<!-- LIST TAB -->
<section id="tab-list" class="tab-content active">
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
        <div style="flex: 1; min-width: 200px;">
            <label style="margin-bottom: 4px; font-size: 0.85em;">Search:</label>
            <input type="text" id="searchInput" placeholder="Search title, author..." style="margin: 0;">
        </div>
        <div style="min-width: 150px;">
            <label style="margin-bottom: 4px; font-size: 0.85em;">Shelf:</label>
            <select id="shelfFilter" style="margin: 0;"></select>
        </div>
        <button id="sortRecentBtn">Recent ‚Üì</button>
<button id="addBook" class="primary">Add Book</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th data-col="title">Title <span class="sort"></span></th>
                    <th data-col="rating">Rtg <span class="sort"></span></th>
                    <th data-col="author">Author <span class="sort"></span></th>
                    <th data-col="shelves">Shelves</th>
                    <th data-col="pages">Pgs <span class="sort"></span></th>
                    <th data-col="year">Yr <span class="sort"></span></th>
                    <th data-col="dateRead">Read <span class="sort"></span></th>
                    <th data-col="readCount">Cnt <span class="sort"></span></th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</section>

<!-- PROFILE TAB -->
<section id="tab-profile" class="tab-content">
    <div style="max-width: 800px; margin: 0 auto;">
        <div class="profile-header">
            <div class="profile-pic-container">
                <img id="profilePic" class="profile-pic" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23555'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E">
                <input type="file" id="profilePicInput" accept="image/*" style="display:none;">
            </div>
            <div style="flex: 1; width: 100%;">
                <input type="text" id="profileNick" placeholder="Nickname" style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                <textarea id="profileBio" placeholder="Tell us about yourself..." style="height: 60px;"></textarea>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="stats-card">
                <div id="profileTotalBooks" class="stats-value">0</div>
                <div class="stats-label">Books Read</div>
            </div>
            <div class="stats-card">
                <div id="profileTotalPages" class="stats-value">0</div>
                <div class="stats-label">Pages Read</div>
            </div>
        </div>

        <div id="recentBooksContainer"></div>

        <h3 class="profile-section-title" style="margin-top: 30px;">Favourites</h3>
        <div id="favouritesContainer" class="book-grid"></div>
    </div>
</section>

<!-- STATS TAB -->
<section id="tab-stats" class="tab-content">
    <div class="stats-card" style="max-width: 800px; margin: 0 auto;">
        <canvas id="statsChart"></canvas>
    </div>
    <div id="textStats" style="margin-top: 20px; max-width: 800px; margin-left: auto; margin-right: auto;"></div>
</section>

<!-- OPTIONS TAB -->
<section id="tab-options" class="tab-content">
    <div style="max-width: 600px; margin: 0 auto;">
        <h3>Import / Export</h3>
        <div style="background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <label>Import JSON/CSV:</label>
            <input type="file" id="fileInput" accept=".csv,.json">
            <div style="margin-top: 10px;">
                <button id="exportData">Export Backup</button>
                <button id="clearStorage" class="danger" style="margin-left: 10px;">Clear All Data</button>
            </div>
        </div>

        <h3>Goals</h3>
        <div style="background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Year</label><input type="number" id="goalYear" value="2026"></div>
                <div style="flex:1"><label>Book Goal</label><input type="number" id="yearBooksGoal"></div>
                <div style="flex:1"><label>Page Goal</label><input type="number" id="yearGoal"></div>
            </div>
            <button id="saveGoal" class="primary" style="margin-top: 10px;">Save Goal</button>
        </div>

        <h3>Settings</h3>
        <div style="background: #222; padding: 15px; border-radius: 8px;">
            <label><input type="checkbox" id="showNumbers"> Show Row Numbers in List</label>
        </div>

        <h3>Manage Shelves</h3>
        <div style="background: #222; padding: 15px; border-radius: 8px;">
            <div id="shelfManager"></div>
        </div>
    </div>
</section>

<!-- EDIT MODAL -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">Edit Book</div>
        
        <label>Title <input type="text" id="editTitle"></label>
        <label>Author <input type="text" id="editAuthor"></label>
        <div style="display: flex; gap: 10px;">
            <div style="flex:1"><label>Series <input type="text" id="editSeries"></label></div>
            <div style="flex:1"><label>Pages <input type="number" id="editPages"></label></div>
        </div>

        <label>Shelves (comma separated) <input type="text" id="editShelves"></label>
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>Status
                    <select id="editExclusiveShelf">
                        <option value="read">read</option>
                        <option value="currently-reading">currently-reading</option>
                        <option value="to-read">to-read</option>
                    </select>
                </label>
            </div>
            <div style="flex:1">
                <label>Rating (0-5) <input type="number" id="editRating" min="0" max="5"></label>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex:1"><label>Date Read <input type="text" id="editDateRead" placeholder="YYYY-MM-DD"></label></div>
            <div style="flex:1"><label>Read Count <input type="number" id="editReadCount"></label></div>
            <div style="flex:1"><label>Year Pub <input type="number" id="editYear"></label></div>
        </div>

        <div style="margin-top: 10px; background: #333; padding: 10px; border-radius: 4px;">
            <label style="margin-bottom:4px; font-weight:bold;">Favourites Options</label>
            <label style="margin-bottom:0; display: flex; align-items: center;">
                <input type="checkbox" id="editFavourite"> Add to Favourites
            </label>
            <label style="margin-bottom:0; margin-top:4px; display: flex; align-items: center; font-size: 0.9em; color:#ccc;">
                <input type="checkbox" id="editShowSeriesFav"> Show Series Name in Favourites
            </label>
        </div>
        
        <label style="margin-top:10px;">Notes <textarea id="editNotes"></textarea></label>
        
        <div class="modal-footer">
            <button id="removeBook" class="danger">Delete Book</button>
            <div style="display: flex; gap: 10px;">
                <button id="closeEdit">Cancel</button>
                <button id="saveEdit" class="primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * 1. INITIALIZATION & GLOBAL VARIABLES
 * Defining these at the very top prevents "ReferenceError" during Firebase callbacks.
 */
const firebaseConfig = {
  apiKey: "AIzaSyA8UlXHK1HPSeKAuCfEquonyjnT24ZWjcA",
  authDomain: "readinglist-75c4a.firebaseapp.com",
  projectId: "readinglist-75c4a",
  storageBucket: "readinglist-75c4a.firebasestorage.app",
  messagingSenderId: "717466374536",
  appId: "1:717466374536:web:a331148d9d3c378dd0ea3d"
};

// Keys for LocalStorage
const STORAGE_KEY = "reading_list_data";
const SHOW_NUM_KEY = "reading_list_show_numbers";
const TAB_KEY = "reading_list_active_tab";
const GOALS_KEY = "reading_goals_per_year";
const SHELF_COLORS_KEY = "reading_shelf_colors";
const PROFILE_KEY = "reading_list_profile";

// Global State - Loaded immediately from local storage so render is instant
let books = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
let shelfColors = JSON.parse(localStorage.getItem(SHELF_COLORS_KEY) || "{}");
let goals = JSON.parse(localStorage.getItem(GOALS_KEY) || "{}");
let profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
if (!profile.favourites) profile.favourites = [];

let currentUser = null;
let isApplyingRemote = false;
let sortState = { column: "recent", direction: -1 };

// Init Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const firestore = firebase.firestore();

// Enable offline persistence (better mobile sync)
firebase.firestore().enablePersistence({ synchronizeTabs: true })
  .catch((err) => {
      console.warn("Firestore persistence not enabled:", err.code);
  });

/**
 * 2. AUTHENTICATION LOGIC
 */
// A. Set persistence to LOCAL immediately
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .catch(err => console.error("Persistence error:", err));

// B. Handle Redirect Result (Crucial for Mobile)
auth.getRedirectResult()
    .then((result) => {
        if (result.user) {
            console.log("Redirect login success:", result.user.displayName);
            document.getElementById("syncStatus").textContent = "Redirect successful. Syncing...";
        }
        // Force button state just in case
        document.getElementById("signInBtn").disabled = false;
    })
    .catch((error) => {
        console.error("Redirect error:", error);
        document.getElementById("signInBtn").disabled = false;
        document.getElementById("syncStatus").textContent = "Login Error: " + error.message;
    });

// C. Auth State Listener
auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
        document.getElementById("signInBtn").style.display = "none";
        document.getElementById("signOutBtn").style.display = "inline-block";
        document.getElementById("syncStatus").textContent = `Signed in: ${user.displayName || user.email}`;

        // Load cloud data
        loadFromFirestore();  // <‚Äî simplified
    } else {
        document.getElementById("signInBtn").style.display = "inline-block";
        document.getElementById("signOutBtn").style.display = "none";
        document.getElementById("syncStatus").textContent = "Local Mode (offline)";
        loadAllFromStorage();
    }
});

}

    } else {
        // Logged Out
        document.getElementById("signInBtn").style.display = "inline-block";
        document.getElementById("signOutBtn").style.display = "none";
        document.getElementById("syncStatus").textContent = "Not signed in (Local only)";
        document.getElementById("signInBtn").disabled = false;
    }
});

// Fail-safe: show local data if Firebase doesn't respond quickly
setTimeout(() => {
    const status = document.getElementById("syncStatus");
    if (status.textContent === "Loading local data..." || status.textContent === "Initializing...") {
        loadAllFromStorage(); // ensures UI is populated
        status.textContent = currentUser ? `Signed in: ${currentUser.displayName || currentUser.email}` : "Local Mode (offline)";
        document.getElementById("signInBtn").style.display = "inline-block";
        document.getElementById("signInBtn").disabled = false;
    }
}, 4000);


// Auth Buttons
document.getElementById("signInBtn").addEventListener("click", async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    document.getElementById("signInBtn").disabled = true;
    document.getElementById("syncStatus").textContent = "Signing in...";

    try {
        // Use popup on desktop, redirect only on mobile
        if (window.innerWidth <= 800 && /Mobi|Android/i.test(navigator.userAgent)) {
            await auth.signInWithRedirect(provider);
        } else {
            const result = await auth.signInWithPopup(provider);
            currentUser = result.user;
            document.getElementById("syncStatus").textContent = `Signed in: ${currentUser.displayName}`;
            // Load Firestore immediately after popup login
            loadFromFirestore();
        }
    } catch (err) {
        console.error("Login error:", err);
        document.getElementById("syncStatus").textContent = "Login failed: " + err.message;
        document.getElementById("signInBtn").disabled = false;
    }
});


document.getElementById("signOutBtn").addEventListener("click", () => {
    auth.signOut().then(() => location.reload());
});


/**
 * 3. DATA PERSISTENCE HELPER
 */
function loadAllFromStorage() {
    books = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    shelfColors = JSON.parse(localStorage.getItem(SHELF_COLORS_KEY) || "{}");
    goals = JSON.parse(localStorage.getItem(GOALS_KEY) || "{}");
    profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
    if (!profile.favourites) profile.favourites = [];
    populateShelfFilter();
    document.getElementById("syncStatus").textContent = currentUser ? `Signed in: ${currentUser.displayName || currentUser.email}` : "Local data loaded";

}

function saveAllToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(shelfColors));
    localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    saveToFirebase();
}

async function saveToFirebase() {
    if (!currentUser) return;
    const docRef = firestore.collection("users").doc(currentUser.uid);
    try {
        await docRef.set({
            books,
            profile,
            goals,
            shelfColors
        }, { merge: true });
    } catch (err) {
        console.error("Firestore sync error:", err);
    }
}

async function loadFromFirebase() {
    await loadFromFirestore();
}

async function loadFromFirestore() {
    if (!currentUser) return;

    const docRef = firestore.collection("users").doc(currentUser.uid);
    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();

            // Save everything to localStorage first
            if (data.books) localStorage.setItem(STORAGE_KEY, JSON.stringify(data.books));
            if (data.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(data.profile));
            if (data.goals) localStorage.setItem(GOALS_KEY, JSON.stringify(data.goals));
            if (data.shelfColors) localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(data.shelfColors));
        }

        // Load into memory and render UI
        loadAllFromStorage();

    } catch (err) {
        console.error("Firestore load error:", err);
        document.getElementById("syncStatus").textContent = "Error loading cloud data (offline mode)";
        loadAllFromStorage(); // fallback to local
    }
}



/**
 * 4. UI LOGIC - TABS
 */
function switchTab(name) {
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.toggle("active", c.id === "tab-" + name));
    localStorage.setItem(TAB_KEY, name);
    populateShelfFilter(); // Add this line here
    renderCurrentTab();
}

function renderCurrentTab() {
    // Always render List to keep it updated
    renderTable(); 
    
    // Check active tab
    const active = document.querySelector(".tab.active").dataset.tab;
    if (active === "stats") renderStats();
    if (active === "profile") {
        renderProfileStats();
        renderRecentBooks();
        renderFavourites();
    }
    if (active === "options") {
        renderShelfManager();
        loadGoalsForYear();
    }
}

document.querySelectorAll(".tab").forEach(tab => tab.addEventListener("click", () => switchTab(tab.dataset.tab)));

/**
 * 5. UI LOGIC - LIST & TABLE
 */
function populateShelfFilter() {
    const select = document.getElementById("shelfFilter");
    if (!select) return;
    const currentVal = select.value;
    select.innerHTML = "";
    const shelves = new Set(["all"]);
    books.forEach(b => {
        if (b.exclusiveShelf) shelves.add(b.exclusiveShelf);
        b.shelves.forEach(s => shelves.add(s));
    });
    shelves.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
    });
    if (currentVal && shelves.has(currentVal)) select.value = currentVal;
}

function renderTable() {
    const showNumbers = document.getElementById("showNumbers").checked;
    const filter = document.getElementById("shelfFilter").value;
    const body = document.getElementById("tableBody");
    body.innerHTML = "";

    let list = books.filter(b => filter === "all" || b.exclusiveShelf === filter || b.shelves.includes(filter));
    
   // Sort
if (sortState.column) {
    list.sort((a, b) => {
        let cmp = 0;

        if (sortState.column === "recent") {
            const aVal = a.id || a.importOrder || 0;
            const bVal = b.id || b.importOrder || 0;
            cmp = aVal - bVal;
        } 
        else if (sortState.column === "dateRead") {
            const aVal = a.dateRead ? new Date(a.dateRead.split(',')[0]).getTime() : 0;
            const bVal = b.dateRead ? new Date(b.dateRead.split(',')[0]).getTime() : 0;
            cmp = aVal - bVal;
        } 
        else {
            const valA = a[sortState.column];
            const valB = b[sortState.column];

            if (typeof valA === "number" && typeof valB === "number") {
                cmp = valA - valB;
            } else {
                cmp = String(valA || "").localeCompare(String(valB || ""));
            }
        }

        return cmp * sortState.direction;
    });
}


    // Search
    const query = document.getElementById("searchInput").value.toLowerCase().trim();
    if (query) {
        list = list.filter(b => 
            (b.title && b.title.toLowerCase().includes(query)) || 
            (b.author && b.author.toLowerCase().includes(query)) ||
            (b.series && b.series.toLowerCase().includes(query))
        );
    }

    list.forEach((b, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>
                ${showNumbers ? `<span style="color:#666; font-size:0.8em; margin-right:4px;">${index + 1}.</span>` : ""}
                <span style="font-weight:500;">${b.title}</span>
                ${b.series ? `<div style="font-size:0.8em; color:#888;">${b.series}</div>` : ""}
                ${b.notes ? `<span class="note-icon" title="${b.notes.replace(/"/g, '&quot;')}" style="cursor:help; margin-left:4px;">üìù</span>` : ''}
            </td>
            <td>${b.rating || "-"}</td>
            <td>${b.author}</td>
            <td>
                <span class="tag" style="background:${shelfColors[b.exclusiveShelf] || '#444'}">${b.exclusiveShelf}</span>
                ${b.shelves.map(s => `<span class="tag" style="background:${shelfColors[s] || '#444'}">${s}</span>`).join("")}
            </td>
            <td>${b.pages || "-"}</td>
            <td>${b.year || "-"}</td>
            <td>${b.dateRead || "-"}</td>
            <td>${b.readCount || 1}</td>
            <td><button class="editBtn" style="padding:2px 8px; font-size:0.8em;">Edit</button></td>
        `;
        tr.querySelector(".editBtn").addEventListener("click", () => openEditModal(b));
        body.appendChild(tr);
    });
}

document.querySelectorAll("th[data-col]").forEach(th => {
    th.addEventListener("click", () => {
        const col = th.dataset.col;
        sortState.direction = sortState.column === col ? -sortState.direction : 1;
        sortState.column = col;
        document.querySelectorAll(".sort").forEach(s => s.textContent = "");
        document.getElementById("sortRecentBtn").textContent = "Recent";
        th.querySelector(".sort").textContent = sortState.direction === 1 ? "‚ñ≤" : "‚ñº";
        renderTable();
    });
});

document.getElementById("shelfFilter").addEventListener("change", renderTable);
document.getElementById("searchInput").addEventListener("input", renderTable);
document.getElementById("showNumbers").addEventListener("change", (e) => {
    localStorage.setItem(SHOW_NUM_KEY, e.target.checked);
    renderTable();
});
    document.getElementById("sortRecentBtn").addEventListener("click", () => {
    if (sortState.column !== "recent") {
        sortState.column = "recent";
        sortState.direction = -1;
    } else {
        sortState.direction *= -1;
    }

    document.getElementById("sortRecentBtn").textContent =
        sortState.direction === -1 ? "Recent ‚Üì" : "Recent ‚Üë";

    renderTable();
});

document.getElementById("showNumbers").checked = JSON.parse(localStorage.getItem(SHOW_NUM_KEY) || "true");


/**
 * 6. UI LOGIC - MODAL & EDITING
 */
const editModal = document.getElementById("editModal");
let editingBook = null;

function openEditModal(book) {
    editingBook = book;
    const fields = ['Title', 'Author', 'Series', 'Pages', 'Year', 'DateRead', 'ReadCount', 'Rating', 'Notes', 'ExclusiveShelf'];
    fields.forEach(f => {
        const el = document.getElementById('edit' + f);
        if(el) el.value = book ? (book[f.toLowerCase().replace('dateread','dateRead').replace('readcount','readCount').replace('exclusiveshelf','exclusiveShelf')] || "") : (f==='ReadCount'?'1':'');
    });
    
    document.getElementById("editShelves").value = book ? book.shelves.join(", ") : "";
    document.getElementById("editExclusiveShelf").value = book ? book.exclusiveShelf : "to-read";
    
    // Favourites logic
    const isFav = book ? profile.favourites.includes(book.id || book.importOrder) : false;
    document.getElementById("editFavourite").checked = isFav;
    
    // Show Series in Fav logic
    document.getElementById("editShowSeriesFav").checked = book ? !!book.showSeriesInFav : false;

    document.getElementById("removeBook").style.display = book ? "inline-block" : "none";
    editModal.style.display = "flex";
}

document.getElementById("closeEdit").addEventListener("click", () => editModal.style.display = "none");
document.getElementById("addBook").addEventListener("click", () => openEditModal(null));

document.getElementById("saveEdit").addEventListener("click", () => {
    const newShelves = document.getElementById("editShelves").value.split(",").map(s => s.trim()).filter(Boolean);
    const newData = {
        title: document.getElementById("editTitle").value.trim(),
        author: document.getElementById("editAuthor").value.trim(),
        series: document.getElementById("editSeries").value.trim(),
        pages: Number(document.getElementById("editPages").value) || 0,
        year: Number(document.getElementById("editYear").value) || null,
        dateRead: document.getElementById("editDateRead").value.trim(),
        readCount: Number(document.getElementById("editReadCount").value) || 1,
        rating: Number(document.getElementById("editRating").value) || 0,
        notes: document.getElementById("editNotes").value.trim(),
        exclusiveShelf: document.getElementById("editExclusiveShelf").value,
        shelves: newShelves,
        showSeriesInFav: document.getElementById("editShowSeriesFav").checked
    };

    if (editingBook) {
        // Update existing
        Object.assign(editingBook, newData);
        const bookId = editingBook.id || editingBook.importOrder;
        handleFavourite(bookId);
    } else {
        // Create new
        newData.importOrder = Date.now(); // Simple unique ID
        newData.id = newData.importOrder; 
        books.push(newData);
        handleFavourite(newData.id);
    }
    
    saveAllToStorage();
    editModal.style.display = "none";
    renderCurrentTab();
});

function handleFavourite(id) {
    const checked = document.getElementById("editFavourite").checked;
    if (checked) {
        if (!profile.favourites.includes(id)) profile.favourites.push(id);
    } else {
        profile.favourites = profile.favourites.filter(fid => fid !== id);
    }
}

document.getElementById("removeBook").addEventListener("click", () => {
    if (!confirm("Delete this book permanently?")) return;
    if (editingBook) {
        const id = editingBook.id || editingBook.importOrder;
        books = books.filter(b => b !== editingBook);
        profile.favourites = profile.favourites.filter(fid => fid !== id);
        saveAllToStorage();
        editModal.style.display = "none";
        renderCurrentTab();
    }
});


/**
 * 7. UI LOGIC - PROFILE
 */
function renderProfileStats() {
    const read = books.filter(b => b.exclusiveShelf === "read");
    document.getElementById("profileTotalBooks").textContent = read.length;
    document.getElementById("profileTotalPages").textContent = read.reduce((sum, b) => sum + (b.pages || 0), 0).toLocaleString();
    
    // Pic & Info
    if (profile.picture) document.getElementById("profilePic").src = profile.picture;
    document.getElementById("profileNick").value = profile.nick || "";
    document.getElementById("profileBio").value = profile.bio || "";
}

// Autosave Profile inputs
document.getElementById("profileNick").addEventListener("input", e => { profile.nick = e.target.value; saveAllToStorage(); });
document.getElementById("profileBio").addEventListener("input", e => { profile.bio = e.target.value; saveAllToStorage(); });

// Profile Pic
document.getElementById("profilePic").addEventListener("click", () => document.getElementById("profilePicInput").click());
document.getElementById("profilePicInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
            profile.picture = ev.target.result;
            document.getElementById("profilePic").src = profile.picture;
            saveAllToStorage();
        };
        reader.readAsDataURL(file);
    }
});

function renderRecentBooks() {
    const container = document.getElementById("recentBooksContainer");
    container.innerHTML = "";

    // 1. Currently Reading
    const current = books.filter(b => b.exclusiveShelf === 'currently-reading');
    
    // 2. Recently Finished (Read, sorted by dateRead DESC, max 12)
    const recentlyFinished = books.filter(b => b.exclusiveShelf === 'read')
        .sort((a, b) => {
            const dA = a.dateRead ? new Date(a.dateRead.split(',')[0]).getTime() : 0;
            const dB = b.dateRead ? new Date(b.dateRead.split(',')[0]).getTime() : 0;
            return dB - dA;
        })
        .slice(0, 12);
        
    // 3. Up Next (To-read, sorted by importOrder/id DESC, max 6)
    const upNext = books.filter(b => b.exclusiveShelf === 'to-read')
        .sort((a, b) => (b.id || b.importOrder) - (a.id || a.importOrder))
        .slice(0, 6);

    // Helpers
    const createSection = (title, bookList) => {
        const titleEl = document.createElement('h3');
        titleEl.className = "profile-section-title";
        titleEl.textContent = title;
        container.appendChild(titleEl);
        
        const grid = document.createElement('div');
        grid.className = "book-grid";
        if (bookList.length === 0) {
            grid.innerHTML = `<div style="color:#666; font-size:0.9em; grid-column:1/-1;">None found.</div>`;
        } else {
            bookList.forEach(b => grid.appendChild(createBookCard(b)));
        }
        container.appendChild(grid);
    };

    createSection("Currently Reading", current);
    createSection("Recently Finished", recentlyFinished);
    createSection("Up Next (To Read)", upNext);
}

function renderFavourites() {
    const container = document.getElementById("favouritesContainer");
    container.innerHTML = "";
    const favs = books.filter(b => profile.favourites.includes(b.id || b.importOrder));
    if (favs.length === 0) {
        container.innerHTML = '<div style="color:#666; grid-column:1/-1;">No favourites selected.</div>';
        return;
    }
    favs.forEach(b => container.appendChild(createBookCard(b, true)));
}

function createBookCard(b, isFavSection = false) {
    const div = document.createElement("div");
    div.className = "book-card";
    // Check if we show Series Name or Title
    let displayTitle = b.title;
    if (isFavSection && b.showSeriesInFav && b.series) {
        displayTitle = b.series;
    }
    
    div.innerHTML = `<div class="book-title">${displayTitle}</div><div class="book-author">${b.author}</div>`;
    div.addEventListener("click", () => openEditModal(b));
    return div;
}

/**
 * 8. UI LOGIC - STATS
 */
function renderStats() {
    const selectedYear = Number(document.getElementById("goalYear").value);
    const read = books.filter(b => b.exclusiveShelf === "read");
    
    // Per Year Calc
    const perYear = {};
    read.forEach(b => {
        if (!b.dateRead) return;
        const dates = b.dateRead.split(",");
        dates.forEach(d => {
            const y = new Date(d.trim()).getFullYear();
            if (!isNaN(y)) {
                if (!perYear[y]) perYear[y] = { books: 0, pages: 0 };
                perYear[y].books++;
                perYear[y].pages += (b.pages || 0);
            }
        });
    });

    const years = Object.keys(perYear).sort();
    
    // Text Stats
    const totalPages = read.reduce((s, b) => s + (b.pages || 0), 0);
    const textStats = document.getElementById("textStats");
    textStats.innerHTML = `
        <div class="stats-grid">
            <div>All Time Books Read: ${read.length}</div>
            <div>All Time Pages Read: ${totalPages.toLocaleString()}</div>
        </div>
        <hr style="border-color:#333; margin:15px 0;">
        <strong>Goal Progress (${selectedYear})</strong><br>
        Books: ${perYear[selectedYear]?.books || 0} / ${goals[selectedYear]?.books || "-"} <br>
        Pages: ${perYear[selectedYear]?.pages || 0} / ${goals[selectedYear]?.pages || "-"}
    `;

    // Chart
    if (window.statsChartInstance) window.statsChartInstance.destroy();
    const ctx = document.getElementById('statsChart').getContext('2d');
    window.statsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: years,
            datasets: [
                { label: 'Books', data: years.map(y => perYear[y].books), backgroundColor: '#4299e1', yAxisID: 'y' },
                { label: 'Pages', data: years.map(y => perYear[y].pages), backgroundColor: '#9f7aea', yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { ticks: { color: '#ccc' } },
                y: { type: 'linear', position: 'left', ticks: { color: '#ccc' } },
                y1: { type: 'linear', position: 'right', ticks: { color: '#ccc' }, grid: { drawOnChartArea: false } }
            },
            plugins: { legend: { labels: { color: '#ccc' } } }
        }
    });
}

/**
 * 9. UI LOGIC - OPTIONS & SHELVES
 */
function renderShelfManager() {
    const div = document.getElementById("shelfManager");
    div.innerHTML = "";
    
    // Collect all shelves
    const allShelves = new Set();
    books.forEach(b => b.shelves.forEach(s => allShelves.add(s)));
    
    allShelves.forEach(s => {
        const row = document.createElement("div");
        row.style.marginBottom = "8px";
        row.innerHTML = `
            <div style="display:flex; gap:8px;">
                <input type="text" value="${s}" readonly style="width:120px; background:#333; border:none; color:#bbb;">
                <input type="color" value="${shelfColors[s] || '#666666'}" class="color-picker">
                <button class="delete-shelf danger" style="padding:2px 6px;">X</button>
            </div>
        `;
        
        row.querySelector(".color-picker").addEventListener("change", (e) => {
            shelfColors[s] = e.target.value;
            saveAllToStorage();
        });
        
        row.querySelector(".delete-shelf").addEventListener("click", () => {
            if(confirm(`Remove shelf "${s}" from all books?`)) {
                books.forEach(b => b.shelves = b.shelves.filter(x => x !== s));
                saveAllToStorage();
                renderShelfManager();
            }
        });
        div.appendChild(row);
    });
}

// Goal Inputs
function loadGoalsForYear() {
    const y = document.getElementById("goalYear").value;
    const g = goals[y] || {};
    document.getElementById("yearBooksGoal").value = g.books || "";
    document.getElementById("yearGoal").value = g.pages || "";
}
document.getElementById("goalYear").addEventListener("change", loadGoalsForYear);

document.getElementById("saveGoal").addEventListener("click", () => {
    const y = document.getElementById("goalYear").value;
    goals[y] = {
        books: Number(document.getElementById("yearBooksGoal").value) || 0,
        pages: Number(document.getElementById("yearGoal").value) || 0
    };
    saveAllToStorage();
    alert("Goals saved!");
});

// Import / Export
document.getElementById("exportData").addEventListener("click", () => {
    const data = JSON.stringify({ books, goals, profile, shelfColors }, null, 2);
    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "reading-list-backup.json";
    a.click();
});

document.getElementById("fileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const d = JSON.parse(ev.target.result);
            if (d.books) books = d.books;
            if (d.goals) goals = d.goals;
            if (d.profile) profile = d.profile;
            if (d.shelfColors) shelfColors = d.shelfColors;
            saveAllToStorage();
            alert("Import successful!");
            location.reload();
        } catch (err) {
            alert("Error importing file: " + err);
        }
    };
    reader.readAsText(file);
});

document.getElementById("clearStorage").addEventListener("click", () => {
    if (confirm("Delete EVERYTHING? This cannot be undone.")) {
        localStorage.clear();
        location.reload();
    }
});

// Initial Render - Use DOMContentLoaded to ensure elements exist
window.addEventListener('DOMContentLoaded', () => {
    loadAllFromStorage(); // Ensure memory is populated from local storage
    const savedTab = localStorage.getItem(TAB_KEY) || "list";
    switchTab(savedTab);
    populateShelfFilter(); // Populate the dropdown
    renderTable(); // Force the first render
});

</script>
</body>
</html>





