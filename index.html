<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reading List</title>
<style>
body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    padding: 20px;
}
h1 { font-size: 1.6em; margin-bottom: 6px; }
.tabs { display: flex; justify-content: flex-end; gap: 6px; margin-bottom: 12px; }
.tab { padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; color: #ccc; cursor: pointer; }
.tab.active { background: #222; color: #fff; border-color: #555; }
.tab:hover { background: #2a2a2a; }
.tab-content { display: none; }
.tab-content.active { display: block; }
input, select, textarea { margin: 8px 0; padding: 6px; background: #222; color: #eee; border: 1px solid #444; }
button { margin-left: 8px; padding: 6px 10px; background: #222; color: #eee; border: 1px solid #444; cursor: pointer; }
button:hover { background: #2a2a2a; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
th, td { padding: 6px; border-bottom: 1px solid #333; text-align: left; }
th { background: #1a1a1a; cursor: pointer; user-select: none; }
tr:hover { background: #1f1f1f; }
.sort { margin-left: 4px; opacity: 0.6; }
.stats-upper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
.stats-block { background: #1a1a1a; border: 1px solid #333; padding: 12px; flex: 1; min-width: 280px; max-height: 400px; overflow-y: auto; }
.stats-block h2 { margin: 0 0 10px 0; font-size: 1em; }
.stats-grid { display: grid; grid-template-columns: auto auto; gap: 4px 16px; }
.stats-list { font-size: 0.9em; }
.stats-year-block { background: #1a1a1a; border: 1px solid #333; padding: 12px; margin-bottom: 20px; }
#statsChartContainer { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 6px; max-width: 100%; margin: 0 auto; }
#statsChart { width: 100%; height: 500px; }
.card-container { display: flex; flex-wrap: wrap; gap: 12px; }
.book-card { background:#222; padding:10px; border:1px solid #444; border-radius:6px; width:160px; text-align:center; cursor:pointer; position:relative; height:100px; display:flex; flex-direction:column; justify-content:center; }
.book-card:hover { background:#2a2a2a; }
.book-card.dragging { opacity: 0.5; }
.book-card .profile-book-title { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95em; }
.book-card .profile-book-author { display: block; margin-top: 4px; font-size: 0.85em; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.book-card small { display:block; margin-top:4px; font-size:0.8em; color:#ccc; }
.modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top:12px; }
.modal-actions-right { display: flex; gap: 8px; }
button.danger { background-color: #8b2c2c; color: white; border: none; }
button.danger:hover { background-color: #a83838; }
#filterInfo { cursor: help; color: #888; }
#cloudButtons { margin-top: 12px; }
.profile-recent-section h4 { margin: 16px 0 8px 0; font-size:1em; }
#goalsSection { background: #1a1a1a; padding: 16px; border: 1px solid #333; border-radius: 8px; margin: 16px 0; }
#goalsSection h3 { margin-top: 0; }
#goalsSection .goals-inline { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
#generalSettings { background: #1a1a1a; padding: 16px; border: 1px solid #333; border-radius: 8px; margin: 16px 0; }
.hidden-date { font-size: 0.85em; color: #aaa; }
.timeline-entry { margin-bottom: 16px; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; }
.timeline-entry h4 { margin: 0 0 8px 0; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>Reading List</h1>
<div class="tabs">
    <button class="tab" data-tab="profile">Profile</button>
    <button class="tab active" data-tab="list">List</button>
    <button class="tab" data-tab="stats">Stats</button>
    <button class="tab" data-tab="timeline">Timeline</button>
    <button class="tab" data-tab="options">Options</button>
</div>
<section id="tab-list" class="tab-content active">
    <label>Filter by shelf: <select id="shelfFilter"></select></label>
    <button id="sortRecent" style="margin-left: 12px;">Sort by recent <span id="recentSortIndicator">‚ñº</span></button>
    <button id="addBook" style="margin-top:12px;">Add New Book</button>
    <label style="margin-left:15px">
        Search: <input type="text" id="searchInput" style="width:300px" placeholder="Search title, author, series or use filters">
        <span id="filterInfo">?</span>
    </label>
    <table>
        <thead>
            <tr>
                <th data-col="title">Title <span class="sort"></span></th>
                <th data-col="rating">Rating <span class="sort"></span></th>
                <th data-col="author">Author <span class="sort"></span></th>
                <th data-col="shelves">Shelves <span class="sort"></span></th>
                <th data-col="pages">Pages <span class="sort"></span></th>
                <th data-col="year">Year <span class="sort"></span></th>
                <th data-col="dateRead">Date Read <span class="sort"></span></th>
                <th data-col="readCount">Read Count <span class="sort"></span></th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</section>
<section id="tab-stats" class="tab-content">
    <div id="stats"></div>
    <div id="statsChartContainer"><canvas id="statsChart"></canvas></div>
</section>
<section id="tab-timeline" class="tab-content">
    <div id="timelineContainer"></div>
</section>
<section id="tab-profile" class="tab-content">
    <div id="profileContainer" style="max-width:800px; margin:auto;">
        <div style="display:flex; gap:16px; align-items:center; margin-bottom:16px;">
            <div>
                <img id="profilePic" src="https://via.placeholder.com/100?text=?" alt="Profile Picture" style="width:100px;height:100px;object-fit:cover;border:2px solid #555; cursor:pointer; border-radius:50%;">
                <input type="file" id="profilePicInput" accept="image/*" style="display:none;">
            </div>
            <div style="flex:1;">
                <input type="text" id="profileNick" placeholder="Nickname" style="width:100%; margin-bottom:8px;">
                <textarea id="profileBio" placeholder="Bio" style="width:100%; height:80px; resize:vertical;"></textarea>
            </div>
        </div>
        <div id="profileStats"></div>
        <div class="profile-recent-section">
            <h3>Recent Activity</h3>
            <div id="recentBooksContainer" class="card-container"></div>
        </div>
        <div class="profile-recent-section">
            <h3>Favourites</h3>
            <div id="favouritesContainer" class="card-container"></div>
        </div>
    </div>
</section>
<section id="tab-options" class="tab-content">
    <h3>Import / Export</h3>
    <label>Import list: <input type="file" id="fileInput" accept=".csv,.json"></label>
    <button id="exportData">Export list</button>
    <button id="clearStorage" style="margin-left:12px;">Clear local list data</button>
    <hr style="border:1px solid #333; margin:16px 0;">
    <div id="goalsSection">
        <h3>Yearly Goals</h3>
        <div class="goals-inline">
            <label>Year: <input type="number" id="goalYear" style="width:80px;"></label>
            <label>Books goal: <input type="number" id="yearBooksGoal" style="width:100px;"></label>
            <label>Pages goal: <input type="number" id="yearPagesGoal" style="width:100px;"></label>
            <button id="saveGoal">Save</button>
            <button id="removeGoal">Remove</button>
        </div>
    </div>
    <div id="generalSettings">
        <h3>General Settings</h3>
        <label><input type="checkbox" id="showNumbers" checked> Show row numbers</label><br><br>
        <label>Min books read for author avg rating: <input type="number" id="minAuthorBooks" min="1" value="2" style="width:80px;"></label>
    </div>
    <hr style="border:1px solid #333; margin:16px 0;">
    <h3>Cloud Sync (Firebase - Manual only)</h3>
    <div id="syncStatus" style="margin-bottom:8px; color:#ccc;">Not signed in (local only)</div>
    <input type="email" id="authEmail" placeholder="Email" style="width:200px;"><br>
    <input type="password" id="authPassword" placeholder="Password" style="width:200px;"><br>
    <button id="signInBtn">Sign In</button>
    <button id="signUpBtn" style="margin-left:8px;">Sign Up</button>
    <button id="signOutBtn" style="display:none; margin-left:8px;">Sign Out</button>
    <div id="cloudButtons" style="display:none;">
        <button id="saveCloudBtn">Save to Cloud (overwrite cloud)</button>
        <button id="loadCloudBtn">Load from Cloud (overwrite local)</button>
    </div>
    <hr style="border:1px solid #333; margin:16px 0;">
    <h3>Manage Shelves</h3>
    <div id="shelfManager"></div>
    <hr style="border:1px solid #333; margin:16px 0;">
    Version 1.4.5 ‚Äì fixed critical script crash from duplicate code
</section>
<!-- Edit Modal -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#222; padding:20px; border:1px solid #444; max-width:500px; width:100%; max-height:90vh; overflow-y:auto;">
        <h3>Edit Book</h3>
        <label>Title: <input type="text" id="editTitle" placeholder="Title" style="width:100%;"></label><br>
        <label>Author: <input type="text" id="editAuthor" placeholder="Author" style="width:100%;"></label><br>
        <label>Series: <input type="text" id="editSeries" style="width:100%;"></label><br>
        <label>Shelves (comma separated): <input type="text" id="editShelves" style="width:100%;"></label><br>
        <label>Status:
            <select id="editExclusiveShelf" style="width:100%;">
                <option value="read">read</option>
                <option value="currently-reading">currently-reading</option>
                <option value="to-read">to-read</option>
                <option value="dnf">dnf</option>
            </select>
        </label><br>
        <label>Pages: <input type="number" id="editPages"></label><br>
        <label>Year: <input type="number" id="editYear"></label><br>
        <label>Date Read(s) (comma separated): <input type="text" id="editDateRead"></label><br>
        <label>Read Count: <input type="number" id="editReadCount" min="0" value="0"></label><br>
        <label>Rating (0-5): <input type="number" id="editRating" min="0" max="5"></label><br>
        <label>Favourite book: <input type="checkbox" id="editFavourite"></label><br>
        <label id="favSeriesLabel">Favourite series: <input type="checkbox" id="editFavouriteSeries"></label><br>
        <label>Bump to top in recent sort: <input type="checkbox" id="editBumpRecent"></label><br>
        <label class="hidden-date">Date added (hidden): <input type="date" id="editDateAdded"></label></label><br>
        <label class="hidden-date">Date started (hidden): <input type="date" id="editDateStarted"></label></label><br>
        <textarea id="editNotes" placeholder="Notes" style="width:100%; height:80px; resize:vertical;"></textarea>
        <div class="modal-footer">
            <button id="removeBook" class="danger">Remove</button>
            <div class="modal-actions-right">
                <button id="saveEdit">Save</button>
                <button id="closeEdit">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA8UlXHK1HPSeKAuCfEquonyjnT24ZWjcA",
  authDomain: "readinglist-75c4a.firebaseapp.com",
  databaseURL: "https://readinglist-75c4a-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "readinglist-75c4a",
  storageBucket: "readinglist-75c4a.firebasestorage.app",
  messagingSenderId: "717466374536",
  appId: "1:717466374536:web:a331148d9d3c378dd0ea3d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// Element references
const goalYear = document.getElementById("goalYear");
const yearBooksGoal = document.getElementById("yearBooksGoal");
const yearPagesGoal = document.getElementById("yearPagesGoal");
const cloudButtons = document.getElementById("cloudButtons");
const minAuthorBooksInput = document.getElementById("minAuthorBooks");

// Global state
let currentUser = null;
let userRef = null;
let editingBook = null;
let books = [];
let nextImportOrder = 1;
let sortState = { column: null, direction: 1 };
const STORAGE_KEY = "reading_list_data";
const SHOW_NUM_KEY = "reading_list_show_numbers";
const TAB_KEY = "reading_list_active_tab";
const GOALS_KEY = "reading_goals_per_year";
const SHELF_COLORS_KEY = "reading_shelf_colors";
const PROFILE_KEY = "reading_list_profile";
const MIN_AUTHOR_BOOKS_KEY = "reading_min_author_books";
let shelfColors = {};
let goals = {};
let profile = { favourites: [], favouriteSeries: [] };
let draggedElement = null;
let minAuthorBooks = 2;

// Helpers
function getLatestReadTimestamp(book) {
    if (!book.dateRead || book.exclusiveShelf !== "read") return 0;
    const times = book.dateRead.split(",").map(d => new Date(d.trim()).getTime()).filter(t => !isNaN(t));
    return times.length ? Math.max(...times) : 0;
}
function getActivityTimestamp(book) {
    const primary = book.lastFinished ?? book.dateStarted ?? book.dateAdded ?? Number.NEGATIVE_INFINITY;
    const bump = book.bumpTime ?? Number.NEGATIVE_INFINITY;
    return Math.max(primary, bump);
}
function createBookCard(book) {
    const div = document.createElement("div");
    div.className = "book-card";
    div.dataset.bookId = book.importOrder;
    div.innerHTML = `
        <strong class="profile-book-title">${book.title || "No title"}</strong>
        <span class="profile-book-author">${book.author || ""}</span>
    `;
    div.title = `${book.title} ‚Äî ${book.author}`;
    div.addEventListener("click", () => openEditModal(book));
    return div;
}
function createSeriesCard(series) {
    const seriesBooks = books.filter(b => b.series === series);
    if (seriesBooks.length === 0) return null;
    const author = seriesBooks[0].author || "Various";
    const count = seriesBooks.length;
    const div = document.createElement("div");
    div.className = "book-card";
    div.innerHTML = `
        <strong class="profile-book-title">${series}</strong>
        <span class="profile-book-author">${author}</span>
        <small>${count} book${count > 1 ? 's' : ''}</small>
    `;
    div.title = `${series} (${count} books)`;
    return div;
}
function makeFavouritesDraggable(container) {
    container.addEventListener("dragstart", e => {
        const card = e.target.closest(".book-card");
        if (card) {
            draggedElement = card;
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
        }
    });
    container.addEventListener("dragover", e => {
        e.preventDefault();
        const card = e.target.closest(".book-card");
        if (card && card !== draggedElement) {
            const rect = card.getBoundingClientRect();
            const next = (e.clientY - rect.top) > (rect.height / 2);
            if (next && card.nextSibling !== draggedElement) {
                container.insertBefore(draggedElement, card.nextSibling);
            } else if (!next && card !== draggedElement.nextSibling) {
                container.insertBefore(draggedElement, card);
            }
        }
    });
    container.addEventListener("dragend", () => {
        if (draggedElement) {
            draggedElement.classList.remove("dragging");
            profile.favourites = Array.from(container.querySelectorAll(".book-card")).map(c => Number(c.dataset.bookId));
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            draggedElement = null;
        }
    });
    container.addEventListener("drop", e => e.preventDefault());
}

// Note popup
let notePopup = null;
function createNotePopup() {
    notePopup = document.createElement("div");
    notePopup.style.position = "absolute";
    notePopup.style.background = "#222";
    notePopup.style.color = "#eee";
    notePopup.style.padding = "8px";
    notePopup.style.border = "1px solid #444";
    notePopup.style.borderRadius = "4px";
    notePopup.style.zIndex = "3000";
    notePopup.style.display = "none";
    notePopup.style.maxWidth = "300px";
    notePopup.style.pointerEvents = "none";
    document.body.appendChild(notePopup);
    return notePopup;
}
function showNotePopup(popup, text) {
    popup.textContent = text;
    popup.style.display = "block";
    document.addEventListener("mousemove", moveNotePopup);
}
function hideNotePopup(popup) {
    popup.style.display = "none";
    document.removeEventListener("mousemove", moveNotePopup);
}
function moveNotePopup(e) {
    if (!notePopup) return;
    notePopup.style.left = (e.clientX + 15) + "px";
    notePopup.style.top = (e.clientY + 20) + "px";
}

// Auth listener
auth.onAuthStateChanged(user => {
    currentUser = user;
    const syncStatus = document.getElementById("syncStatus");
    const signInBtn = document.getElementById("signInBtn");
    const signUpBtn = document.getElementById("signUpBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    if (user) {
        userRef = db.ref("users/" + user.uid);
        syncStatus.textContent = `Signed in as ${user.email} (manual sync)`;
        signInBtn.style.display = "none";
        signUpBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        cloudButtons.style.display = "block";
    } else {
        userRef = null;
        syncStatus.textContent = "Not signed in (local only)";
        signInBtn.style.display = "inline-block";
        signUpBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        cloudButtons.style.display = "none";
    }
    loadLocalData();
    renderAll();
});

// Load local data + migration
function loadLocalData() {
    const savedBooks = localStorage.getItem(STORAGE_KEY);
    if (savedBooks) {
        try { books = JSON.parse(savedBooks); } catch { books = []; }
    } else {
        books = [];
    }
    let maxOrder = 0;
    books.forEach(b => {
        if (!b.importOrder) b.importOrder = nextImportOrder++;
        maxOrder = Math.max(maxOrder, b.importOrder ?? 0);
        if (b.lastModified != null) {
            if (b.bumpTime == null) b.bumpTime = b.lastModified;
            delete b.lastModified;
        }
        if (b.exclusiveShelf === "currently-reading" && b.dateStarted == null) b.dateStarted = b.dateAdded ?? 0;
        if (b.exclusiveShelf === "read" && b.lastFinished == null) {
            const ts = getLatestReadTimestamp(b);
            if (ts > 0) b.lastFinished = ts;
        }
    });
    nextImportOrder = maxOrder + 1;
    const savedProfile = localStorage.getItem(PROFILE_KEY);
    profile = savedProfile ? JSON.parse(savedProfile) : { favourites: [], favouriteSeries: [] };
    profile.favourites = (profile.favourites || []).filter(id => typeof id === 'number' && books.some(b => b.importOrder === id));
    profile.favouriteSeries = (profile.favouriteSeries || []).filter(s => typeof s === 'string');
    goals = JSON.parse(localStorage.getItem(GOALS_KEY) || "{}");
    shelfColors = JSON.parse(localStorage.getItem(SHELF_COLORS_KEY) || "{}");
    document.getElementById("showNumbers").checked = JSON.parse(localStorage.getItem(SHOW_NUM_KEY) || "true");
    minAuthorBooks = Number(localStorage.getItem(MIN_AUTHOR_BOOKS_KEY)) || 2;
    minAuthorBooksInput.value = minAuthorBooks;
    document.getElementById("profileNick").value = profile.nick || "";
    document.getElementById("profileBio").value = profile.bio || "";
    if (profile.picture) document.getElementById("profilePic").src = profile.picture;
    loadGoalsForYear();
}
function saveBooksToLocal() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
}

// Shelf filter population
function populateShelfFilter() {
    const select = document.getElementById("shelfFilter");
    select.innerHTML = '<option value="all">all</option>';
    const set = new Set();
    books.forEach(b => {
        if (b.exclusiveShelf) set.add(b.exclusiveShelf);
        (b.shelves || []).forEach(s => set.add(s));
    });
    [...set].sort().forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
    });
    if (select.value !== "all" && ![...set].includes(select.value)) {
        select.value = "all";
    }
}

// Cloud save
document.getElementById("saveCloudBtn").addEventListener("click", () => {
    if (!currentUser) return alert("Sign in first");
    if (!confirm("Overwrite cloud data with current local data?")) return;
    const dataToSave = {
        books: books,
        profile: profile,
        goals: goals,
        shelfColors: shelfColors,
        settings: { showNumbers: document.getElementById("showNumbers").checked }
    };
    userRef.set(dataToSave)
        .then(() => alert("Saved to cloud successfully!"))
        .catch(err => alert("Save failed: " + err.message));
});

// Cloud load
document.getElementById("loadCloudBtn").addEventListener("click", () => {
    if (!currentUser) return alert("Sign in first");
    if (!confirm("Overwrite local data with cloud data? This cannot be undone.")) return;
    userRef.once("value")
        .then(snap => {
            const data = snap.val();
            if (!data) return alert("No data in cloud");
            let loadedBooks = data.books || [];
            if (!Array.isArray(loadedBooks)) loadedBooks = Object.values(loadedBooks);
            books = loadedBooks;
            let maxOrder = 0;
            books.forEach(b => {
                if (!b.importOrder) b.importOrder = nextImportOrder++;
                maxOrder = Math.max(maxOrder, b.importOrder ?? 0);
                if (b.lastModified != null) {
                    if (b.bumpTime == null) b.bumpTime = b.lastModified;
                    delete b.lastModified;
                }
                if (b.exclusiveShelf === "currently-reading" && b.dateStarted == null) {
                    b.dateStarted = b.dateAdded ?? 0;
                }
                if (b.exclusiveShelf === "read" && b.lastFinished == null) {
                    const ts = getLatestReadTimestamp(b);
                    if (ts > 0) b.lastFinished = ts;
                }
            });
            nextImportOrder = maxOrder + 1;
            profile = data.profile || { favourites: [], favouriteSeries: [] };
            profile.favourites = (profile.favourites || []).filter(id =>
                typeof id === 'number' && books.some(b => b.importOrder === id)
            );
            goals = data.goals || {};
            shelfColors = data.shelfColors || {};
            const settings = data.settings || {};
            document.getElementById("showNumbers").checked = settings.showNumbers ?? true;
            document.getElementById("profileNick").value = profile.nick || "";
            document.getElementById("profileBio").value = profile.bio || "";
            if (profile.picture) document.getElementById("profilePic").src = profile.picture;
            saveBooksToLocal();
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
            localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
            localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(shelfColors));
            localStorage.setItem(SHOW_NUM_KEY, document.getElementById("showNumbers").checked);
            renderAll();
            loadGoalsForYear();
            alert("Loaded from cloud successfully!");
        })
        .catch(err => alert("Load failed: " + err.message));
});

// Tab switching
function switchTab(name) {
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.toggle("active", c.id === "tab-" + name));
    localStorage.setItem(TAB_KEY, name);
    if (name === "options") renderShelfManager();
    if (name === "stats") renderStats();
    if (name === "profile") {
        renderProfileStats();
        renderRecentBooks();
        renderFavourites();
    }
    if (name === "timeline") renderTimeline();
}
function renderAll() {
    populateShelfFilter();
    renderTable();
    renderStats();
    renderProfileStats();
    renderRecentBooks();
    renderFavourites();
    renderTimeline();
    if (document.querySelector('.tab.active')?.dataset.tab === "options") renderShelfManager();
}

// Modal
function openEditModal(book = null) {
    editingBook = book;
    document.getElementById("editTitle").value = book?.title || "";
    document.getElementById("editAuthor").value = book?.author || "";
    document.getElementById("editSeries").value = book?.series || "";
    document.getElementById("editShelves").value = (book?.shelves || []).join(", ");
    document.getElementById("editExclusiveShelf").value = book?.exclusiveShelf || "to-read";
    document.getElementById("editPages").value = book?.pages || "";
    document.getElementById("editYear").value = book?.year || "";
    document.getElementById("editDateRead").value = book?.dateRead || "";
    document.getElementById("editReadCount").value = book?.readCount ?? 0;
    document.getElementById("editRating").value = book?.rating || 0;
    document.getElementById("editNotes").value = book?.notes || "";
    document.getElementById("editFavourite").checked = !!book && profile.favourites.includes(book.importOrder);
    document.getElementById("editBumpRecent").checked = false;
    const series = book?.series || "";
    if (series) {
        document.getElementById("favSeriesLabel").style.display = "block";
        document.getElementById("editFavouriteSeries").checked = profile.favouriteSeries.includes(series);
    } else {
        document.getElementById("favSeriesLabel").style.display = "none";
    }
    const today = new Date().toISOString().substring(0,10);
    document.getElementById("editDateAdded").value = book?.dateAdded ? new Date(book.dateAdded).toISOString().substring(0,10) : today;
    document.getElementById("editDateStarted").value = book?.dateStarted ? new Date(book.dateStarted).toISOString().substring(0,10) : "";
    document.getElementById("editModal").style.display = "flex";
}
function closeEditModal() {
    editingBook = null;
    document.getElementById("editModal").style.display = "none";
}

// Table rendering
function renderTable() {
    const showNumbers = document.getElementById("showNumbers").checked;
    const filter = document.getElementById("shelfFilter").value;
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    let list = books.slice();
    if (filter !== "all") {
        list = list.filter(b => b.exclusiveShelf === filter || (b.shelves || []).includes(filter));
    }
    const query = document.getElementById("searchInput").value.trim();
    if (query) list = filterBooksByQuery(list, query);
    if (sortState.column) {
        list.sort((a, b) => compare(a, b, sortState.column) * sortState.direction);
    } else {
        list.sort((a, b) => (getActivityTimestamp(b) - getActivityTimestamp(a)) * sortState.direction);
    }
    list.forEach((book, idx) => {
        const tr = document.createElement("tr");
        const shelvesDisplay = [book.exclusiveShelf, ...(book.shelves || [])].filter(Boolean)
            .map(sh => `<span style="background:${shelfColors[sh] || '#888'}; padding:2px 4px; margin-right:2px; border-radius:3px;">${sh}</span>`)
            .join("");
        tr.innerHTML = `
            <td>${showNumbers ? (idx + 1) + ". " : ""}${book.title || ""}${book.notes ? ' <span class="noteIcon" style="cursor:help;color:#888;">üìù</span>' : ''}</td>
            <td>${book.rating || "-"}</td>
            <td>${book.author || ""}</td>
            <td>${shelvesDisplay}</td>
            <td>${book.pages || "-"}</td>
            <td>${book.year ?? "-"}</td>
            <td>${book.dateRead || "-"}</td>
            <td>${book.readCount ?? "-"}</td>
            <td><button class="editBtn" style="padding:2px 6px;">‚úé</button></td>
        `;
        tbody.appendChild(tr);
        tr.querySelector(".editBtn").addEventListener("click", () => openEditModal(book));
        if (book.notes) {
            const icon = tr.querySelector(".noteIcon");
            const popup = notePopup || createNotePopup();
            icon.addEventListener("mouseenter", () => showNotePopup(popup, book.notes));
            icon.addEventListener("mouseleave", () => hideNotePopup(popup));
        }
    });
}

// Sorting
function compare(a, b, col) {
    let av = a[col];
    let bv = b[col];
    if (col === "year") {
        av = av ?? Infinity;
        bv = bv ?? Infinity;
        return av - bv;
    }
    if (col === "pages" || col === "rating" || col === "readCount") {
        av = av ?? 0;
        bv = bv ?? 0;
        return av - bv;
    }
    if (col === "dateRead") {
        return getLatestReadTimestamp(a) - getLatestReadTimestamp(b);
    }
    if (col === "shelves") {
        av = [a.exclusiveShelf, ...(a.shelves || [])].join(", ");
        bv = [b.exclusiveShelf, ...(b.shelves || [])].join(", ");
    }
    av = av ?? "";
    bv = bv ?? "";
    return String(av).localeCompare(String(bv));
}
function handleSort(col) {
    if (sortState.column === col) {
        sortState.direction *= -1;
    } else {
        sortState.column = col;
        sortState.direction = 1;
    }
    updateSortIndicators();
    renderTable();
}
function updateSortIndicators() {
    document.querySelectorAll(".sort").forEach(s => s.textContent = "");
    document.getElementById("recentSortIndicator").textContent = "";
    if (sortState.column) {
        const el = document.querySelector(`th[data-col="${sortState.column}"] .sort`);
        if (el) el.textContent = sortState.direction > 0 ? "‚ñ≤" : "‚ñº";
    } else {
        document.getElementById("recentSortIndicator").textContent = sortState.direction > 0 ? "‚ñº" : "‚ñ≤";
    }
}

// Search
function filterBooksByQuery(list, query) {
    const terms = query.toLowerCase().match(/\S+/g) || [];
    return list.filter(book => {
        let match = true;
        for (const term of terms) {
            let m;
            if ((m = term.match(/^rated([<>=!]+)?(\d+)$/))) {
                let op = m[1] || "=";
                const num = Number(m[2]);
                const val = book.rating ?? 0;
                if (op === ">") match = match && val > num;
                else if (op === ">=") match = match && val >= num;
                else if (op === "<") match = match && val < num;
                else if (op === "<=") match = match && val <= num;
                else if (op === "=" || op === "==") match = match && val === num;
                else if (op === "!=") match = match && val !== num;
            } else if ((m = term.match(/^count([<>=!]+)?(\d+)$/))) {
                let op = m[1] || "=";
                const num = Number(m[2]);
                const val = book.readCount ?? 0;
                if (op === ">") match = match && val > num;
                else if (op === ">=") match = match && val >= num;
                else if (op === "<") match = match && val < num;
                else if (op === "<=") match = match && val <= num;
                else if (op === "=" || op === "==") match = match && val === num;
                else if (op === "!=") match = match && val !== num;
            } else if ((m = term.match(/^pages([<>=!]+)?(\d+)$/i))) {
                let op = m[1] || "=";
                const num = Number(m[2]);
                const val = book.pages ?? 0;
                if (op === ">") match = match && val > num;
                else if (op === ">=") match = match && val >= num;
                else if (op === "<") match = match && val < num;
                else if (op === "<=") match = match && val <= num;
                else if (op === "=" || op === "==") match = match && val === num;
                else if (op === "!=") match = match && val !== num;
            } else if ((m = term.match(/^year([<>=!]+)?(-?\d+)$/i))) {
                let op = m[1] || "=";
                const num = Number(m[2]);
                if (book.year == null) { match = false; continue; }
                const val = book.year;
                if (op === ">") match = match && val > num;
                else if (op === ">=") match = match && val >= num;
                else if (op === "<") match = match && val < num;
                else if (op === "<=") match = match && val <= num;
                else if (op === "=" || op === "==") match = match && val === num;
                else if (op === "!=") match = match && val !== num;
            } else if ((m = term.match(/^date([<>=!]+)(\d{4})$/))) {
                const op = m[1], num = Number(m[2]);
                const dates = (book.dateRead || "").split(",").map(d => d.trim()).filter(Boolean);
                const firstYear = dates.length ? new Date(dates[0]).getFullYear() : null;
                if (firstYear === null) { match = false; continue; }
                if (op === ">") match = match && firstYear > num;
                else if (op === ">=") match = match && firstYear >= num;
                else if (op === "<") match = match && firstYear < num;
                else if (op === "<=") match = match && firstYear <= num;
                else if (op === "=") match = match && firstYear === num;
                else if (op === "!=") match = match && firstYear !== num;
            } else {
                const text = `${book.title} ${book.author} ${book.series || ""} ${book.notes || ""}`.toLowerCase();
                match = match && text.includes(term);
            }
            if (!match) return false;
        }
        return match;
    });
}
function calculatePerYear() {
    const perYear = {};
    books.forEach(b => {
        if (b.exclusiveShelf !== "read" || !b.dateRead) return;
        b.dateRead.split(",").map(d => d.trim()).filter(Boolean).forEach(dateStr => {
            const dt = new Date(dateStr);
            if (isNaN(dt)) return;
            const y = dt.getFullYear();
            perYear[y] = perYear[y] || { books: 0, pages: 0 };
            perYear[y].books++;
            perYear[y].pages += b.pages || 0;
        });
    });
    return perYear;
}

// Timeline
function renderTimeline() {
    const container = document.getElementById("timelineContainer");
    container.innerHTML = "";
    const readBooks = books.filter(b => b.exclusiveShelf === "read" && b.dateRead);
    if (!readBooks.length) {
        container.innerHTML = "<p>No reading history yet.</p>";
        return;
    }
    const entries = [];
    readBooks.forEach(b => {
        const dates = b.dateRead.split(",").map(d => d.trim()).filter(Boolean);
        dates.forEach(dateStr => {
            const dt = new Date(dateStr);
            if (isNaN(dt)) return;
            entries.push({ book: b, date: dt });
        });
    });
    if (entries.length === 0) {
        container.innerHTML = "<p>No valid read dates.</p>";
        return;
    }
    entries.sort((a, b) => b.date - a.date);
    const groups = {};
    const userLocale = navigator.language || 'en-US';
    entries.forEach(entry => {
        const year = entry.date.getFullYear();
        const monthNum = entry.date.getMonth() + 1;
        const monthPadded = String(monthNum).padStart(2, '0');
        const monthName = entry.date.toLocaleString(userLocale, { month: 'long' });
        const key = `${year}-${monthPadded}`;
        if (!groups[key]) groups[key] = { display: `${year} ${monthName}`, entries: [] };
        groups[key].entries.push(entry);
    });
    const sortedKeys = Object.keys(groups).sort().reverse();
    sortedKeys.forEach(key => {
        const g = groups[key];
        const div = document.createElement("div");
        div.className = "timeline-entry";
        div.innerHTML = `<h4>${g.display} (${g.entries.length} read${g.entries.length > 1 ? 's' : ''})</h4>`;
        const ul = document.createElement("ul");
        g.entries.forEach(entry => {
            const li = document.createElement("li");
            const readDate = entry.date.toLocaleDateString(userLocale);
            li.innerHTML = `<strong>${entry.book.title}</strong> by ${entry.book.author || "Unknown"} (${entry.book.rating || "unrated"}) ‚Äî finished ${readDate}`;
            ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
    });
}

// Stats
function renderStats() {
    const container = document.getElementById("stats");
    const ctx = document.getElementById("statsChart").getContext("2d");
    if (window.statsChart && typeof window.statsChart.destroy === 'function') {
        window.statsChart.destroy();
    }
    window.statsChart = null;

    const perYear = calculatePerYear();
    const readBooks = books.filter(b => b.exclusiveShelf === "read");
    const dnfBooks = books.filter(b => b.exclusiveShelf === "dnf");
    const pagesRead = readBooks.reduce((s, b) => s + (b.pages || 0) * Math.max(1, b.readCount || 1), 0);
    const selectedYear = Number(goalYear.value) || new Date().getFullYear();
    const currentPages = perYear[selectedYear]?.pages || 0;
    const currentBooks = perYear[selectedYear]?.books || 0;
    const pagesGoal = goals[selectedYear]?.pages || 0;
    const booksGoal = goals[selectedYear]?.books || 0;

    const authorStats = {};
    readBooks.forEach(b => {
        const auth = b.author || "Unknown";
        if (!authorStats[auth]) authorStats[auth] = { count: 0, ratingSum: 0, rated: 0 };
        authorStats[auth].count++;
        if (b.rating > 0) {
            authorStats[auth].ratingSum += b.rating;
            authorStats[auth].rated++;
        }
    });
    const topByCount = Object.entries(authorStats).sort((a, b) => b[1].count - a[1].count).slice(0, 10);
    const topByAvg = Object.entries(authorStats)
        .filter(([, s]) => s.count >= minAuthorBooks && s.rated > 0)
        .map(([a, s]) => [a, (s.ratingSum / s.rated).toFixed(2), s.rated])
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    let longest = null, shortest = null, mostReread = null;
    let maxYearBooks = 0, maxYearPages = 0, maxYearBooksYear = null, maxYearPagesYear = null;
    readBooks.forEach(b => {
        if (!longest || b.pages > longest.pages) longest = b;
        if (!shortest || (b.pages > 0 && b.pages < shortest.pages)) shortest = b;
        if (!mostReread || b.readCount > mostReread.readCount) mostReread = b;
    });
    Object.entries(perYear).forEach(([y, s]) => {
        if (s.books > maxYearBooks) { maxYearBooks = s.books; maxYearBooksYear = y; }
        if (s.pages > maxYearPages) { maxYearPages = s.pages; maxYearPagesYear = y; }
    });

    let html = '<div class="stats-upper">';
    html += '<div class="stats-block"><h2>Overall Stats</h2>';
    if (pagesGoal || booksGoal) {
        html += `<div style="background:#222; padding:12px; margin-bottom:12px; border-radius:6px;">
            <strong>${selectedYear} Goals</strong><br>
            ${booksGoal ? `Books: ${currentBooks} / ${booksGoal}<br>` : ""}
            ${pagesGoal ? `Pages: ${currentPages} / ${pagesGoal}` : ""}
        </div>`;
    }
    html += '<div class="stats-grid">';
    html += `<div>Total books</div><div>${books.length || 0}</div>`;
    html += `<div>Read</div><div>${readBooks.length}</div>`;
    html += `<div>DNF</div><div>${dnfBooks.length}</div>`;
    html += `<div>Pages read (√ó count)</div><div>${pagesRead}</div>`;
    html += '</div></div>';

    html += '<div class="stats-block"><h2>Favorite Authors</h2><div class="stats-list">';
    html += '<strong>By books read:</strong><br>';
    topByCount.forEach(([a, s]) => html += `‚Ä¢ ${a}: ${s.count} book${s.count > 1 ? 's' : ''}<br>`);
    html += `<br><strong>By average rating (min ${minAuthorBooks} books):</strong><br>`;
    if (topByAvg.length === 0) html += "No authors meet minimum<br>";
    topByAvg.forEach(([a, avg, rated]) => html += `‚Ä¢ ${a}: ${avg} (${rated} rated)<br>`);
    html += '</div></div>';

    html += '<div class="stats-block"><h2>Personal Records</h2><div class="stats-list">';
    if (longest) html += `Longest book: <strong>${longest.title}</strong> (${longest.pages} pages)<br>`;
    if (shortest) html += `Shortest book: <strong>${shortest.title}</strong> (${shortest.pages} pages)<br>`;
    if (mostReread && mostReread.readCount > 1) html += `Most re-read: <strong>${mostReread.title}</strong> (${mostReread.readCount} times)<br>`;
    if (maxYearBooksYear) html += `Most books in a year: ${maxYearBooks} (${maxYearBooksYear})<br>`;
    if (maxYearPagesYear) html += `Most pages in a year: ${maxYearPages} (${maxYearPagesYear})<br>`;
    html += '</div></div>';

    html += '</div>';

    html += '<div class="stats-year-block"><h2>By Year</h2><div class="stats-list">';
    if (Object.keys(perYear).length === 0) html += "none";
    else Object.keys(perYear).sort((a,b)=>b-a).forEach(y => html += `${y}: ${perYear[y].books} books, ${perYear[y].pages} pages<br>`);
    html += '</div></div>';

    container.innerHTML = html;

    const labels = Object.keys(perYear).sort((a,b) => a - b);
    if (labels.length === 0) return;
    const booksData = labels.map(y => perYear[y].books);
    const pagesData = labels.map(y => perYear[y].pages);
    window.statsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [
            { label: 'Books', data: booksData, backgroundColor: 'rgba(75, 192, 192, 0.6)', yAxisID: 'y' },
            { label: 'Pages', data: pagesData, backgroundColor: 'rgba(153, 102, 255, 0.6)', yAxisID: 'y1' }
        ]},
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, position: 'left', ticks: { color: '#eee' }, grid: { color: '#333' } },
                y1: { beginAtZero: true, position: 'right', ticks: { color: '#eee' }, grid: { drawOnChartArea: false } }
            },
            plugins: { legend: { labels: { color: '#eee' } } }
        }
    });
}

// Other renders
function renderProfileStats() {
    const container = document.getElementById("profileStats");
    const readBooks = books.filter(b => b.exclusiveShelf === "read");
    const ratedBooks = readBooks.filter(b => b.rating > 0);
    const pagesRead = readBooks.reduce((s, b) => s + (b.pages || 0) * Math.max(1, b.readCount || 1), 0);
    const avgRating = ratedBooks.length ? (ratedBooks.reduce((s, b) => s + b.rating, 0) / ratedBooks.length).toFixed(1) : "-";
    container.innerHTML = `
        <h2>Reading Stats</h2>
        <div class="stats-grid">
            <div>Books read</div><div>${readBooks.length}</div>
            <div>Pages read</div><div>${pagesRead}</div>
            <div>Average rating</div><div>${avgRating}</div>
        </div>
    `;
}
function renderShelfManager() {
    const container = document.getElementById("shelfManager");
    container.innerHTML = "";
    const set = new Set();
    books.forEach(b => (b.shelves || []).forEach(s => set.add(s)));
    [...set].sort().forEach(shelf => {
        const div = document.createElement("div");
        div.style.marginBottom = "8px";
        div.innerHTML = `
            <input type="text" value="${shelf}" style="width:150px;" class="shelfName">
            <input type="color" value="${shelfColors[shelf] || '#888888'}" class="shelfColor">
            <button class="renameShelf">Rename</button>
            <button class="deleteShelf">Delete</button>
        `;
        container.appendChild(div);
        div.querySelector(".shelfColor").addEventListener("input", e => {
            shelfColors[shelf] = e.target.value;
            localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(shelfColors));
            renderTable();
        });
        div.querySelector(".renameShelf").addEventListener("click", () => {
            const newName = div.querySelector(".shelfName").value.trim();
            if (!newName || newName === shelf) return;
            if (!confirm(`Rename "${shelf}" ‚Üí "${newName}" everywhere?`)) return;
            books.forEach(b => {
                if (b.shelves) b.shelves = b.shelves.map(s => s === shelf ? newName : s);
            });
            shelfColors[newName] = shelfColors[shelf] || '#888888';
            delete shelfColors[shelf];
            localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(shelfColors));
            saveBooksToLocal();
            renderAll();
        });
        div.querySelector(".deleteShelf").addEventListener("click", () => {
            if (!confirm(`Remove shelf "${shelf}" from all books?`)) return;
            books.forEach(b => {
                if (b.shelves) b.shelves = b.shelves.filter(s => s !== shelf);
            });
            delete shelfColors[shelf];
            localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(shelfColors));
            saveBooksToLocal();
            renderAll();
        });
    });
}
function renderRecentBooks() {
    const container = document.getElementById("recentBooksContainer");
    container.innerHTML = "";
    const sortDesc = (a, b) => getActivityTimestamp(b) - getActivityTimestamp(a);
    let currently = books.filter(b => b.exclusiveShelf === "currently-reading");
    if (currently.length) {
        const section = document.createElement("div");
        section.innerHTML = "<h4>Currently Reading</h4><div class=\"card-container\"></div>";
        container.appendChild(section);
        currently.sort(sortDesc).forEach(b => section.querySelector(".card-container").appendChild(createBookCard(b)));
    }
    let finished = books.filter(b => b.exclusiveShelf === "read" && b.lastFinished);
    if (finished.length) {
        const section = document.createElement("div");
        section.innerHTML = "<h4>Recently Finished</h4><div class=\"card-container\"></div>";
        container.appendChild(section);
        finished.sort(sortDesc).slice(0, 8).forEach(b => section.querySelector(".card-container").appendChild(createBookCard(b)));
    }
    let toread = books.filter(b => b.exclusiveShelf === "to-read");
    if (toread.length) {
        const section = document.createElement("div");
        section.innerHTML = "<h4>Recently Added to To-Read</h4><div class=\"card-container\"></div>";
        container.appendChild(section);
        toread.sort(sortDesc).slice(0, 4).forEach(b => section.querySelector(".card-container").appendChild(createBookCard(b)));
    }
    if (!container.innerHTML.trim()) container.innerHTML = "<p>No activity yet.</p>";
}
function renderFavourites() {
    const container = document.getElementById("favouritesContainer");
    container.innerHTML = "";
    let hasContent = false;
    if (profile.favouriteSeries.length) {
        const section = document.createElement("div");
        section.innerHTML = "<h4>Favourite Series</h4><div class=\"card-container\"></div>";
        container.appendChild(section);
        profile.favouriteSeries.sort().forEach(series => {
            const card = createSeriesCard(series);
            if (card) {
                hasContent = true;
                section.querySelector(".card-container").appendChild(card);
            }
        });
    }
    if (profile.favourites.length) {
        const favBooks = profile.favourites.map(id => books.find(b => b.importOrder === id)).filter(Boolean);
        if (favBooks.length) {
            hasContent = true;
            const section = document.createElement("div");
            section.innerHTML = "<h4>Favourite Books</h4><div class=\"card-container\"></div>";
            container.appendChild(section);
            const favContainer = section.querySelector(".card-container");
            favBooks.forEach(book => {
                const card = createBookCard(book);
                card.draggable = true;
                favContainer.appendChild(card);
            });
            makeFavouritesDraggable(favContainer);
        }
    }
    if (!hasContent) container.innerHTML = "<p>No favourites yet.</p>";
}

// Goals
function loadGoalsForYear() {
    const year = Number(goalYear.value) || new Date().getFullYear();
    goalYear.value = year;
    const g = goals[year] || {};
    yearPagesGoal.value = g.pages || "";
    yearBooksGoal.value = g.books || "";
}
goalYear.addEventListener("change", () => {
    loadGoalsForYear();
    renderStats();
});
document.getElementById("saveGoal").addEventListener("click", () => {
    const year = Number(goalYear.value) || new Date().getFullYear();
    const pages = Number(yearPagesGoal.value) || 0;
    const booksGoal = Number(yearBooksGoal.value) || 0;
    if (pages || booksGoal) {
        goals[year] = { pages, books: booksGoal };
    } else {
        delete goals[year];
    }
    localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    renderStats();
});
document.getElementById("removeGoal").addEventListener("click", () => {
    const year = Number(goalYear.value);
    if (goals[year] && confirm(`Remove goals for ${year}?`)) {
        delete goals[year];
        localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
        loadGoalsForYear();
        renderStats();
    }
});
minAuthorBooksInput.addEventListener("change", () => {
    minAuthorBooks = Math.max(1, Number(minAuthorBooksInput.value) || 2);
    localStorage.setItem(MIN_AUTHOR_BOOKS_KEY, minAuthorBooks);
    renderStats();
});

// Save edit
document.getElementById("saveEdit").addEventListener("click", () => {
    const now = Date.now();
    const data = {
        title: document.getElementById("editTitle").value.trim(),
        author: document.getElementById("editAuthor").value.trim(),
        series: document.getElementById("editSeries").value.trim(),
        shelves: document.getElementById("editShelves").value.split(",").map(s => s.trim()).filter(Boolean),
        exclusiveShelf: document.getElementById("editExclusiveShelf").value,
        pages: Number(document.getElementById("editPages").value) || 0,
        year: Number(document.getElementById("editYear").value) || null,
        dateRead: document.getElementById("editDateRead").value.trim(),
        readCount: Number(document.getElementById("editReadCount").value) || 0,
        rating: Number(document.getElementById("editRating").value) || 0,
        notes: document.getElementById("editNotes").value.trim()
    };
    const bumpNow = document.getElementById("editBumpRecent").checked;
    if (editingBook) {
        Object.assign(editingBook, data);
    } else {
        data.importOrder = nextImportOrder++;
        data.dateAdded = now;
        books.unshift(data);
        editingBook = data;
    }
    const addedDateStr = document.getElementById("editDateAdded").value;
    if (addedDateStr) {
        const temp = new Date(addedDateStr);
        if (!isNaN(temp)) editingBook.dateAdded = temp.getTime();
    } else if (!editingBook.dateAdded) {
        editingBook.dateAdded = now;
    }
    const startedDateStr = document.getElementById("editDateStarted").value;
    let dateStartedVal = editingBook.dateStarted;
    if (startedDateStr) {
        const temp = new Date(startedDateStr);
        if (!isNaN(temp)) dateStartedVal = temp.getTime();
    }
    if (data.exclusiveShelf === "currently-reading") {
        editingBook.dateStarted = dateStartedVal ?? now;
    } else {
        editingBook.dateStarted = null;
    }
    if (data.exclusiveShelf === "read") {
        const timestamps = (data.dateRead || "").split(",")
            .map(d => d.trim())
            .filter(Boolean)
            .map(d => new Date(d).getTime())
            .filter(t => !isNaN(t));
        editingBook.lastFinished = timestamps.length ? Math.max(...timestamps) : now;
    } else {
        editingBook.lastFinished = null;
    }
    if (bumpNow) {
        editingBook.bumpTime = now;
    }
    const bookId = editingBook.importOrder;
    const isFav = document.getElementById("editFavourite").checked;
    if (isFav) {
        if (!profile.favourites.includes(bookId)) profile.favourites.push(bookId);
    } else {
        profile.favourites = profile.favourites.filter(id => id !== bookId);
    }
    const isFavSeries = document.getElementById("editFavouriteSeries").checked;
    if (isFavSeries && data.series && !profile.favouriteSeries.includes(data.series)) {
        profile.favouriteSeries.push(data.series);
    } else if (!isFavSeries && data.series) {
        profile.favouriteSeries = profile.favouriteSeries.filter(s => s !== data.series);
    }
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    saveBooksToLocal();
    renderAll();
    closeEditModal();
});

// Event listeners
document.querySelectorAll(".tab").forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));
document.getElementById("addBook").addEventListener("click", () => openEditModal());
document.getElementById("searchInput").addEventListener("input", renderTable);
document.getElementById("shelfFilter").addEventListener("change", renderTable);
document.querySelectorAll("th[data-col]").forEach(th => th.addEventListener("click", () => handleSort(th.dataset.col)));
document.getElementById("sortRecent").addEventListener("click", () => {
    if (sortState.column === null) {
        sortState.direction *= -1;
    } else {
        sortState.column = null;
        sortState.direction = 1;
    }
    updateSortIndicators();
    renderTable();
});
document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        if (file.name.endsWith(".json")) importJSON(ev.target.result);
        else parseCSV(ev.target.result);
    };
    reader.readAsText(file);
});
document.getElementById("exportData").addEventListener("click", () => {
    const data = { books };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "reading-list-export.json";
    a.click();
    URL.revokeObjectURL(url);
});
document.getElementById("clearStorage").addEventListener("click", () => {
    if (confirm("Clear all local data? (Cloud data stays if signed in)")) {
        localStorage.clear();
        books = [];
        profile = { favourites: [], favouriteSeries: [] };
        goals = {};
        shelfColors = {};
        loadLocalData();
        renderAll();
    }
});
document.getElementById("signInBtn").addEventListener("click", () => {
    const email = document.getElementById("authEmail").value.trim();
    const pass = document.getElementById("authPassword").value;
    if (!email || !pass) return alert("Enter email and password");
    auth.signInWithEmailAndPassword(email, pass).catch(err => alert("Sign in error: " + err.message));
});
document.getElementById("signUpBtn").addEventListener("click", () => {
    const email = document.getElementById("authEmail").value.trim();
    const pass = document.getElementById("authPassword").value;
    if (!email || !pass) return alert("Enter email and password");
    auth.createUserWithEmailAndPassword(email, pass).catch(err => alert("Sign up error: " + err.message));
});
document.getElementById("signOutBtn").addEventListener("click", () => auth.signOut());
document.getElementById("showNumbers").addEventListener("change", () => {
    localStorage.setItem(SHOW_NUM_KEY, document.getElementById("showNumbers").checked);
    renderTable();
});
document.getElementById("profilePic").addEventListener("click", () => document.getElementById("profilePicInput").click());
document.getElementById("profilePicInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        profile.picture = ev.target.result;
        document.getElementById("profilePic").src = profile.picture;
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    };
    reader.readAsDataURL(file);
});
let profileSaveTimeout;
document.getElementById("profileNick").addEventListener("input", () => {
    clearTimeout(profileSaveTimeout);
    profileSaveTimeout = setTimeout(() => {
        profile.nick = document.getElementById("profileNick").value.trim();
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }, 800);
});
document.getElementById("profileBio").addEventListener("input", () => {
    clearTimeout(profileSaveTimeout);
    profileSaveTimeout = setTimeout(() => {
        profile.bio = document.getElementById("profileBio").value.trim();
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }, 800);
});
document.getElementById("removeBook").addEventListener("click", () => {
    if (!editingBook || !confirm("Really remove this book?")) return;
    profile.favourites = profile.favourites.filter(id => id !== editingBook.importOrder);
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    books = books.filter(b => b !== editingBook);
    saveBooksToLocal();
    renderAll();
    closeEditModal();
});
document.getElementById("closeEdit").addEventListener("click", closeEditModal);
document.getElementById("editModal").addEventListener("click", e => {
    if (e.target === document.getElementById("editModal")) closeEditModal();
});
document.getElementById("filterInfo").addEventListener("click", () => {
    alert(`Search syntax:
‚Ä¢ Normal words ‚Üí title / author / series / notes
‚Ä¢ rated>3 rated=0 (unrated) rated>=4 etc.
‚Ä¢ pages>300 pages<=100 pages=500
‚Ä¢ year>=-50 year<10 year=-500 (negative = BC)
‚Ä¢ count>1 (rereads)
‚Ä¢ date=2024 (first read year)
Combine with spaces (AND).`);
});

// Import helpers
function parseCSVLine(line) {
    const result = [];
    let field = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') inQuotes = !inQuotes;
        else if (c === "," && !inQuotes) {
            result.push(field);
            field = "";
        } else field += c;
    }
    result.push(field);
    return result;
}
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return;
    const headers = lines[0].split(",").map(h => h.replace(/^"|"$/g, "").trim());
    const idx = name => headers.findIndex(h => h === name);
    books = [];
    nextImportOrder = 1;
    for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (!cols[idx("Title")]) continue;
        const exclusive = cols[idx("Exclusive Shelf")] || "read";
        let extraShelves = cols[idx("Bookshelves")] ? cols[idx("Bookshelves")].split(",").map(s => s.trim()) : [];
        extraShelves = extraShelves.filter(s => s !== exclusive);
        const book = {
            title: cols[idx("Title")],
            author: cols[idx("Author")],
            series: cols[idx("Series")] || "",
            exclusiveShelf: exclusive,
            shelves: extraShelves,
            pages: Number(cols[idx("Number of Pages")]) || 0,
            year: Number(cols[idx("Original Publication Year")]) || null,
            dateRead: cols[idx("Date Read")] || "",
            readCount: Number(cols[idx("Read Count")]) || 1,
            rating: Number(cols[idx("My Rating")]) || 0,
            notes: cols[idx("My Review")] || "",
            importOrder: nextImportOrder++,
            dateAdded: Date.now()
        };
        if (book.exclusiveShelf === "read") {
            const ts = getLatestReadTimestamp(book);
            if (ts > 0) book.lastFinished = ts;
        }
        books.push(book);
    }
    saveBooksToLocal();
    renderAll();
}
function importJSON(text) {
    let data;
    try { data = JSON.parse(text); } catch { return alert("Invalid JSON"); }
    if (!data.books || !Array.isArray(data.books)) return alert("Invalid export");
    if (!confirm("Import will replace current list. Continue?")) return;
    books = data.books;
    loadLocalData();
    saveBooksToLocal();
    renderAll();
}

// Initial setup
loadLocalData();
const savedTab = localStorage.getItem(TAB_KEY) || "list";
switchTab(savedTab);
renderAll();
goalYear.value = new Date().getFullYear();
loadGoalsForYear();
</script>
</body>
</html>
