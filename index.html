<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reading List</title>
<style>
body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    padding: 20px;
}
h1 { font-size: 1.6em; margin-bottom: 6px; }
.tabs { display: flex; justify-content: flex-end; gap: 6px; margin-bottom: 12px; }
.tab { padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; color: #ccc; cursor: pointer; }
.tab.active { background: #222; color: #fff; border-color: #555; }
.tab:hover { background: #2a2a2a; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.tab-content.active table {
    display: table;
}
input, select { margin: 8px 0; padding: 6px; background: #222; color: #eee; border: 1px solid #444; }
button { margin-left: 8px; padding: 6px 10px; background: #222; color: #eee; border: 1px solid #444; cursor: pointer; }
button:hover { background: #2a2a2a; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
th, td { padding: 6px; border-bottom: 1px solid #333; text-align: left; }
th { background: #1a1a1a; cursor: pointer; user-select: none; }
tr:hover { background: #1f1f1f; }
.sort { margin-left: 4px; opacity: 0.6; }
#stats { background: #1a1a1a; border: 1px solid #333; padding: 12px; max-width: 600px; font-size: 0.9em; }
#stats h2 { margin: 0 0 8px 0; font-size: 1em; }
.stats-grid { display: grid; grid-template-columns: repeat(2, auto); gap: 4px 16px; margin-bottom: 10px; }
.stats-year { margin-top: 6px; font-size: 0.85em; color: #ccc; }
#editModal div::-webkit-scrollbar {
    width: 8px;
}
#editModal div::-webkit-scrollbar-track {
    background: #1a1a1a;
}
#editModal div::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
}
#editModal div::-webkit-scrollbar-thumb:hover {
    background: #666;
}
.modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-actions-right {
    display: flex;
    gap: 8px;
}
button.danger {
    background-color: #8b2c2c;
    color: white;
    border: none;
}
button.danger:hover {
    background-color: #a83838;
}
#statsChart {
    background: #1a1a1a;
    border: 1px solid #333;
    padding: 10px;
    border-radius: 6px;
}
.profile-recent-section h4 {
    margin: 16px 0 8px 0;
    font-size: 1em;
    color: #ccc;
}
.profile-book-title {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
    font-size: 0.85em;
}
.profile-book-author {
    font-size: 0.8em;
    color: #bbb;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>Reading List</h1>
<div class="tabs">
    <button class="tab" data-tab="profile">Profile</button>
    <button class="tab active" data-tab="list">List</button>
    <button class="tab" data-tab="stats">Stats</button>
    <button class="tab" data-tab="options">Options</button>
</div>
<section id="tab-list" class="tab-content active">
    <label>
    Filter by shelf:
    <select id="shelfFilter"></select>
</label>
<button id="sortRecent" style="margin-left: 12px;">Sort by Recent</button>
<button id="addBook" style="margin-top:12px;">Add New Book</button>
<label style="margin-left:15px">
    Search: <input type="text" id="searchInput" style="width:300px" placeholder="Search title, author, series or use filters">
<span id="filterInfo" style="margin-left:5px; cursor:help; color:#888;">?</span>
</label>
    <table>
        <thead>
            <tr>
                <th data-col="title">Title <span class="sort"></span></th>
                <th data-col="rating">Rating <span class="sort"></span></th>
                <th data-col="author">Author <span class="sort"></span></th>
                <th data-col="shelves">Shelves <span class="sort"></span></th>
                <th data-col="pages">Pages <span class="sort"></span></th>
                <th data-col="year">Year <span class="sort"></span></th>
                <th data-col="dateRead">Date Read <span class="sort"></span></th>
                <th data-col="readCount">Read Count <span class="sort"></span></th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</section>
<section id="tab-stats" class="tab-content">
    <div id="stats"></div>
    <canvas id="statsChart" style="max-width:600px; margin-top:20px;"></canvas>
</section>
<section id="tab-profile" class="tab-content">
    <div id="profileContainer" style="max-width:800px; margin:auto;">
        <div style="display:flex; gap:16px; align-items:center; margin-bottom:16px;">
            <div>
                <img id="profilePic" src="" alt="Profile Picture" style="width:100px;height:100px;object-fit:cover;border:2px solid #555; cursor:pointer;">
                <input type="file" id="profilePicInput" accept="image/*" style="display:none;">
            </div>
            <div style="flex:1;">
                <input type="text" id="profileNick" placeholder="Nickname" style="width:100%; margin-bottom:8px; padding:6px; background:#222; color:#eee; border:1px solid #444;">
                <textarea id="profileBio" placeholder="Bio" style="width:100%; padding:6px; background:#222; color:#eee; border:1px solid #444; resize:vertical; height:60px;"></textarea>
            </div>
        </div>
        <div id="profileStats" style="background:#1a1a1a; border:1px solid #333; padding:12px; margin-bottom:16px;"></div>
        <div id="profileRecent" class="profile-recent-section" style="margin-bottom:16px;">
            <h3>Recent Books</h3>
            <div id="recentBooksContainer" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>
        <div id="profileFavourites">
            <h3>Favourites</h3>
            <div id="favouritesContainer" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>
    </div>
</section>
<section id="tab-options" class="tab-content">
<h3>Import / Export</h3>
<label>
    Import list:
    <input type="file" id="fileInput" accept=".csv,.json">
</label>
<button id="exportData">Export list</button>
<button id="clearStorage" style="margin-left:12px;">Clear local list data</button>
<hr style="border:1px solid #333; margin:16px 0;">
    <label>
        Year for goals:
        <input type="number" id="goalYear" style="width:80px;" value="2026">
    </label>
    <br>
    <label>
        Yearly pages goal:
        <input type="number" id="yearGoal" style="width:100px;">
    </label>
    <br>
    <label>
        Yearly books goal:
        <input type="number" id="yearBooksGoal" style="width:100px;">
    </label>
    <br>
    <button id="saveGoal">Save</button>
<button id="removeGoal" style="margin-left:12px;">Remove goals for year</button>
<br>
<hr style="border:1px solid #333; margin:16px 0;">
<h3>Other options</h3>
<label>
    <input type="checkbox" id="showNumbers" checked>
    Show numbers
</label>
<hr style="border:1px solid #333; margin:16px 0;">
<h3>Cloud Sync (Firebase)</h3>
<div id="syncStatus" style="margin-bottom:8px; color:#ccc;">Not signed in</div>
<input type="email" id="authEmail" placeholder="Email" style="margin-bottom:8px; width:200px;">
<input type="password" id="authPassword" placeholder="Password" style="margin-bottom:8px; width:200px;">
<button id="signInBtn">Sign In</button>
<button id="signUpBtn" style="margin-left:8px;">Sign Up</button>
<button id="signOutBtn" style="display:none; margin-left:8px;">Sign Out</button>
<button id="saveCloudBtn" style="margin-bottom:12px;">Save to Cloud</button>
<hr style="border:1px solid #333; margin:16px 0;">
<h3>Manage Shelves</h3>
<div id="shelfManager"></div>
<hr style="border:1px solid #333; margin:16px 0;">
Version 1.0.0.8
</section>

<!-- Edit Book Modal -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:#eee; justify-content:center; align-items:center; z-index:1000; padding:20px;">
    <div style="background:#222; padding:20px; border:1px solid #444; max-width:500px; width:100%; position:relative; max-height:80vh; overflow-y:auto;">
        <h3>Edit Book</h3>
        <label>Title: <input type="text" id="editTitle" style="width:100%;"></label><br>
        <label>Author: <input type="text" id="editAuthor" style="width:100%;"></label><br>
        <label>Series: <input type="text" id="editSeries" style="width:100%;"></label><br>
        <label>Shelves (comma separated): <input type="text" id="editShelves" style="width:100%;"></label><br>
        <label>Status:
            <select id="editExclusiveShelf" style="width:100%;">
                <option value="read">read</option>
                <option value="currently-reading">currently-reading</option>
                <option value="to-read">to-read</option>
            </select>
        </label><br>
        <label>Pages: <input type="number" id="editPages" style="width:100%;"></label><br>
        <label>Year: <input type="number" id="editYear" style="width:100%;"></label><br>
        <label>Date Read(s) (comma separated): <input type="text" id="editDateRead" style="width:100%;"></label><br>
        <label>Read Count: <input type="number" id="editReadCount" style="width:100%;"></label><br>
        <label>Rating: <input type="number" id="editRating" style="width:100%;" min="0" max="5"></label><br>
        <label>Favourite: <input type="checkbox" id="editFavourite"></label><br>
        <textarea id="editNotes" style="width:100%; height:80px; background:#222; color:#eee; border:1px solid #444; padding:6px; resize:vertical;"></textarea>
        <div class="modal-footer">
            <button id="removeBook" class="danger">Remove</button>
            <div class="modal-actions-right">
                <button id="saveEdit">Save</button>
                <button id="closeEdit">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// === DATA STATE & KEYS ===
const STORAGE_KEY = "reading_list_data";
const SHOW_NUM_KEY = "reading_list_show_numbers";
const TAB_KEY = "reading_list_active_tab";
const GOALS_KEY = "reading_goals_per_year";
const SHELF_COLORS_KEY = "reading_shelf_colors";
const PROFILE_KEY = "reading_list_profile";

let books = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
let shelfColors = JSON.parse(localStorage.getItem(SHELF_COLORS_KEY) || "{}");
let goals = JSON.parse(localStorage.getItem(GOALS_KEY) || "{}");
let profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
profile.favourites ??= [];

let sortState = { column: "importOrder", direction: -1 };
let nextImportOrder = books.reduce((max, b) => Math.max(max, b.importOrder ?? 0), 0) + 1;

// === FIREBASE INITIALIZATION ===
const firebaseConfig = {
  apiKey: "AIzaSyA8UlXHK1HPSeKAuCfEquonyjnT24ZWjcA",
  authDomain: "readinglist-75c4a.firebaseapp.com",
  projectId: "readinglist-75c4a",
  storageBucket: "readinglist-75c4a.firebasestorage.app",
  messagingSenderId: "717466374536",
  appId: "1:717466374536:web:a331148d9d3c378dd0ea3d",
  databaseURL: "https://readinglist-75c4a-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let currentUser = null;

auth.onAuthStateChanged(user => {
    currentUser = user;
    const signInBtn = document.getElementById("signInBtn");
    const signUpBtn = document.getElementById("signUpBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const syncStatus = document.getElementById("syncStatus");

    if (user) {
        signInBtn.style.display = "none";
        signUpBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        syncStatus.textContent = `Signed in as ${user.email}`;
        loadFromFirebase();
    } else {
        signInBtn.style.display = "inline-block";
        signUpBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        syncStatus.textContent = "Not signed in (local only)";
    }
});

function showPopup(message, success = true) {
    const popup = document.createElement("div");
    popup.textContent = message;
    popup.style.cssText = `position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:${success ? "#2c8" : "#c22"}; color:#111; padding:12px 20px; border-radius:6px; font-size:0.95em; z-index:10000; box-shadow:0 2px 8px rgba(0,0,0,0.5);`;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 3000);
}

function saveToFirebase() {
    if (!currentUser) {
        showPopup("Please sign in first.", false);
        return;
    }
    const data = {
        books,
        profile,
        goals,
        shelfColors,
        lastUpdated: Date.now()
    };
    db.ref("users/" + currentUser.uid).set(data)
        .then(() => showPopup("Saved to cloud!", true))
        .catch(err => showPopup("Save failed: " + err.message, false));
}

function loadFromFirebase() {
    if (!currentUser) return;
    db.ref("users/" + currentUser.uid).once("value").then(snapshot => {
        const data = snapshot.val();
        if (data) {
            books = data.books || [];
            profile = data.profile || { favourites: [] };
            goals = data.goals || {};
            shelfColors = data.shelfColors || {};
            saveToStorage();
            refreshAllUI();
        }
    });
}

// === STORAGE & UI REFRESH ===
function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    localStorage.setItem(SHELF_COLORS_KEY, JSON.stringify(shelfColors));
}

function refreshAllUI() {
    populateShelfFilter();
    renderTable();
    renderStats();
    renderProfileStats();
    renderRecentBooks();
    renderFavourites();
    document.getElementById("profileNick").value = profile.nick || "";
    document.getElementById("profileBio").value = profile.bio || "";
    if (profile.picture) document.getElementById("profilePic").src = profile.picture;
}

// === FEATURE LOGIC ===
function calculatePerYear() {
    const perYear = {};
    books.forEach(b => {
        if (b.exclusiveShelf !== "read" || !b.dateRead) return;
        const dates = String(b.dateRead).split(",").map(d => d.trim()).filter(Boolean);
        dates.forEach(dateStr => {
            const dt = new Date(dateStr);
            if (isNaN(dt.getTime())) return;
            const y = dt.getFullYear();
            perYear[y] ??= { books: 0, pages: 0 };
            perYear[y].books++;
            perYear[y].pages += (Number(b.pages) || 0);
        });
    });
    return perYear;
}

function getLatestReadTimestamp(book) {
    if (book.exclusiveShelf !== "read" || !book.dateRead) return 0;
    const dates = String(book.dateRead).split(",").map(d => d.trim());
    let maxTs = 0;
    for (let d of dates) {
        const ts = new Date(d).getTime();
        if (!isNaN(ts)) maxTs = Math.max(maxTs, ts);
    }
    return maxTs;
}

function switchTab(name) {
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.toggle("active", c.id === "tab-" + name));
    if (name === "options") renderShelfManager();
    if (name === "stats") renderStats();
    if (name === "profile") { renderProfileStats(); renderRecentBooks(); renderFavourites(); }
    localStorage.setItem(TAB_KEY, name);
}

function renderTable() {
    const showNumbers = document.getElementById("showNumbers").checked;
    const filter = document.getElementById("shelfFilter").value;
    const body = document.getElementById("tableBody");
    body.innerHTML = "";
    
    let list = books.filter(b => filter === "all" || b.exclusiveShelf === filter || (b.shelves && b.shelves.includes(filter)));
    
    if (sortState.column) {
        list.sort((a, b) => {
            let cmp = compare(a, b, sortState.column);
            return cmp * sortState.direction;
        });
    }

    const query = (document.getElementById("searchInput")?.value || "").toLowerCase();
    if (query) {
        list = list.filter(b => 
            b.title.toLowerCase().includes(query) || 
            b.author.toLowerCase().includes(query) || 
            (b.series || "").toLowerCase().includes(query)
        );
    }

    list.forEach((b, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${showNumbers ? (index + 1) + ". " : ""}${b.title} ${b.notes ? 'üìù' : ''}</td>
            <td>${b.rating || "-"}</td>
            <td>${b.author}</td>
            <td>${[b.exclusiveShelf, ...(b.shelves || [])].filter(Boolean).map(sh => `<span style="background:${shelfColors[sh] || '#444'};padding:2px 4px;margin-right:2px;border-radius:3px;font-size:0.8em;">${sh}</span>`).join("")}</td>
            <td>${b.pages || "-"}</td>
            <td>${b.year || "-"}</td>
            <td>${b.dateRead || "-"}</td>
            <td>${b.readCount || "-"}</td>
            <td><button onclick="openEditModalById(${b.importOrder})">‚úé</button></td>
        `;
        body.appendChild(tr);
    });
}

function compare(a, b, col) {
    if (col === "importOrder") return (a.importOrder || 0) - (b.importOrder || 0);
    let x = a[col], y = b[col];
    if (col === "dateRead") return getLatestReadTimestamp(a) - getLatestReadTimestamp(b);
    if (typeof x === "number") return x - y;
    return String(x || "").localeCompare(String(y || ""));
}

function populateShelfFilter() {
    const select = document.getElementById("shelfFilter");
    const current = select.value;
    const shelves = new Set(["all"]);
    books.forEach(b => {
        if (b.exclusiveShelf) shelves.add(b.exclusiveShelf);
        if (b.shelves) b.shelves.forEach(s => shelves.add(s));
    });
    select.innerHTML = "";
    shelves.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s; opt.textContent = s;
        select.appendChild(opt);
    });
    select.value = shelves.has(current) ? current : "all";
}

// === STATS & CHARTS ===
function renderStats() {
    const statsDiv = document.getElementById("stats");
    if (!books.length) return;
    const perYear = calculatePerYear();
    const selectedYear = Number(document.getElementById("goalYear").value);
    const curr = perYear[selectedYear] || { books: 0, pages: 0 };
    const goal = goals[selectedYear] || { books: 0, pages: 0 };

    statsDiv.innerHTML = `
        <h2>Stats Summary</h2>
        <div class="stats-grid">
            <div>Total Books:</div><div>${books.length}</div>
            <div>Read:</div><div>${books.filter(b => b.exclusiveShelf === 'read').length}</div>
            <div>Pages:</div><div>${books.reduce((s, b) => s + (Number(b.pages) || 0), 0)}</div>
        </div>
        <div class="stats-year">
            <strong>${selectedYear} Goal:</strong> ${curr.books}/${goal.books} books, ${curr.pages}/${goal.pages} pages
        </div>
    `;

    const ctx = document.getElementById('statsChart').getContext('2d');
    if (window.statsChartInstance) window.statsChartInstance.destroy();
    const labels = Object.keys(perYear).sort();
    window.statsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{ label: 'Books', data: labels.map(l => perYear[l].books), backgroundColor: '#28c' }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });
}

// === PROFILE RENDERING ===
function renderProfileStats() {
    const div = document.getElementById("profileStats");
    const read = books.filter(b => b.exclusiveShelf === "read");
    div.innerHTML = `
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; text-align:center;">
            <div><strong>${books.length}</strong><br>Books</div>
            <div><strong>${read.length}</strong><br>Read</div>
            <div><strong>${read.reduce((s, b) => s + (Number(b.pages) || 0), 0)}</strong><br>Pages</div>
        </div>
    `;
}

function createBookCard(b) {
    const d = document.createElement("div");
    d.style.cssText = "background:#222; padding:8px; border:1px solid #333; width:120px; border-radius:4px; font-size:0.8em; cursor:pointer;";
    d.innerHTML = `<strong class="profile-book-title">${b.title}</strong><div class="profile-book-author">${b.author}</div>`;
    d.onclick = () => openEditModalById(b.importOrder);
    return d;
}

function renderRecentBooks() {
    const container = document.getElementById("recentBooksContainer");
    container.innerHTML = "";
    books.filter(b => b.exclusiveShelf === "read")
         .sort((a, b) => getLatestReadTimestamp(b) - getLatestReadTimestamp(a))
         .slice(0, 5)
         .forEach(b => container.appendChild(createBookCard(b)));
}

function renderFavourites() {
    const container = document.getElementById("favouritesContainer");
    container.innerHTML = "";
    books.filter(b => profile.favourites.includes(b.importOrder))
         .forEach(b => container.appendChild(createBookCard(b)));
}

// === MODAL LOGIC ===
let editingBookId = null;
function openEditModalById(id) {
    const book = books.find(b => b.importOrder === id);
    if (!book) return;
    editingBookId = id;
    document.getElementById("editTitle").value = book.title;
    document.getElementById("editAuthor").value = book.author;
    document.getElementById("editSeries").value = book.series || "";
    document.getElementById("editShelves").value = (book.shelves || []).join(", ");
    document.getElementById("editExclusiveShelf").value = book.exclusiveShelf;
    document.getElementById("editPages").value = book.pages || "";
    document.getElementById("editYear").value = book.year || "";
    document.getElementById("editDateRead").value = book.dateRead || "";
    document.getElementById("editReadCount").value = book.readCount || 1;
    document.getElementById("editRating").value = book.rating || 0;
    document.getElementById("editFavourite").checked = profile.favourites.includes(id);
    document.getElementById("editNotes").value = book.notes || "";
    document.getElementById("editModal").style.display = "flex";
}

document.getElementById("saveEdit").onclick = () => {
    const book = books.find(b => b.importOrder === editingBookId);
    if (book) {
        book.title = document.getElementById("editTitle").value;
        book.author = document.getElementById("editAuthor").value;
        book.series = document.getElementById("editSeries").value;
        book.shelves = document.getElementById("editShelves").value.split(",").map(s => s.trim()).filter(Boolean);
        book.exclusiveShelf = document.getElementById("editExclusiveShelf").value;
        book.pages = Number(document.getElementById("editPages").value);
        book.year = Number(document.getElementById("editYear").value);
        book.dateRead = document.getElementById("editDateRead").value;
        book.readCount = Number(document.getElementById("editReadCount").value);
        book.rating = Number(document.getElementById("editRating").value);
        book.notes = document.getElementById("editNotes").value;
        
        const isFav = document.getElementById("editFavourite").checked;
        if (isFav && !profile.favourites.includes(editingBookId)) profile.favourites.push(editingBookId);
        else if (!isFav) profile.favourites = profile.favourites.filter(fid => fid !== editingBookId);
        
        saveToStorage();
        refreshAllUI();
        document.getElementById("editModal").style.display = "none";
    }
};

document.getElementById("removeBook").onclick = () => {
    if (confirm("Delete this book?")) {
        books = books.filter(b => b.importOrder !== editingBookId);
        profile.favourites = profile.favourites.filter(fid => fid !== editingBookId);
        saveToStorage();
        refreshAllUI();
        document.getElementById("editModal").style.display = "none";
    }
};

document.getElementById("addBook").onclick = () => {
    const newId = nextImportOrder++;
    books.push({ title: "New Book", author: "Author", importOrder: newId, exclusiveShelf: "to-read", shelves: [] });
    openEditModalById(newId);
};

// === AUTH ACTIONS ===
document.getElementById("signInBtn").onclick = () => {
    auth.signInWithEmailAndPassword(document.getElementById("authEmail").value, document.getElementById("authPassword").value)
        .catch(e => alert(e.message));
};
document.getElementById("signUpBtn").onclick = () => {
    auth.createUserWithEmailAndPassword(document.getElementById("authEmail").value, document.getElementById("authPassword").value)
        .catch(e => alert(e.message));
};
document.getElementById("signOutBtn").onclick = () => auth.signOut();
document.getElementById("saveCloudBtn").onclick = saveToFirebase;

// === TABS & INIT ===
document.querySelectorAll(".tab").forEach(t => t.onclick = () => switchTab(t.dataset.tab));
document.getElementById("closeEdit").onclick = () => document.getElementById("editModal").style.display = "none";
document.getElementById("searchInput").oninput = renderTable;
document.getElementById("shelfFilter").onchange = renderTable;

// Goal saving
document.getElementById("saveGoal").onclick = () => {
    const yr = Number(document.getElementById("goalYear").value);
    goals[yr] = { pages: Number(document.getElementById("yearGoal").value), books: Number(document.getElementById("yearBooksGoal").value) };
    saveToStorage();
    renderStats();
    showPopup("Goal saved locally");
};

// Initial Start
const lastTab = localStorage.getItem(TAB_KEY) || "list";
switchTab(lastTab);
refreshAllUI();
</script>
</body>
</html>
